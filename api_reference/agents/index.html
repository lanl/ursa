
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../combining_arxiv_and_execution_neutronStar/">
      
      
        <link rel="next" href="../prompt_library/">
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>agents - URSA</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ursa.agents" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="URSA" class="md-header__button md-logo" aria-label="URSA" data-md-component="logo">
      
  <img src="../../assets/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            URSA
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              agents
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/lanl/ursa" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="URSA" class="md-nav__button md-logo" aria-label="URSA" data-md-component="logo">
      
  <img src="../../assets/favicon.png" alt="logo">

    </a>
    URSA
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lanl/ursa" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Setup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chatollama_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    chatOllama
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Agents
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Agents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../arxiv_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    arXiv Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../execution_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Execution Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hypothesizer_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hypothesizer Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../planning_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planning Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../web_search_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Search Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../combining_arxiv_and_execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Combining arXiv agent and execution agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../humanInTheLoop_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Human in the Loop
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../combining_arxiv_and_execution_neutronStar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Neutron Star
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    agents
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    agents
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ursa.agents" class="md-nav__link">
    <span class="md-ellipsis">
      agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.__getattr__" class="md-nav__link">
    <span class="md-ellipsis">
      __getattr__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents" class="md-nav__link">
    <span class="md-ellipsis">
      acquisition_agents
    </span>
  </a>
  
    <nav class="md-nav" aria-label="acquisition_agents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.ArxivAgent" class="md-nav__link">
    <span class="md-ellipsis">
      ArxivAgent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.BaseAcquisitionAgent" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAcquisitionAgent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.OSTIAgent" class="md-nav__link">
    <span class="md-ellipsis">
      OSTIAgent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.WebSearchAgent" class="md-nav__link">
    <span class="md-ellipsis">
      WebSearchAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.base" class="md-nav__link">
    <span class="md-ellipsis">
      base
    </span>
  </a>
  
    <nav class="md-nav" aria-label="base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext" class="md-nav__link">
    <span class="md-ellipsis">
      AgentContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgentContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext.llm" class="md-nav__link">
    <span class="md-ellipsis">
      llm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext.tool_character_limit" class="md-nav__link">
    <span class="md-ellipsis">
      tool_character_limit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext.workspace" class="md-nav__link">
    <span class="md-ellipsis">
      workspace
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentWithTools" class="md-nav__link">
    <span class="md-ellipsis">
      AgentWithTools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgentWithTools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentWithTools.add_mcp_tools" class="md-nav__link">
    <span class="md-ellipsis">
      add_mcp_tools
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.compiled_graph" class="md-nav__link">
    <span class="md-ellipsis">
      compiled_graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.context" class="md-nav__link">
    <span class="md-ellipsis">
      context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.name" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.storage" class="md-nav__link">
    <span class="md-ellipsis">
      storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.__init_subclass__" class="md-nav__link">
    <span class="md-ellipsis">
      __init_subclass__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.add_node" class="md-nav__link">
    <span class="md-ellipsis">
      add_node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.ainvoke" class="md-nav__link">
    <span class="md-ellipsis">
      ainvoke
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.build_config" class="md-nav__link">
    <span class="md-ellipsis">
      build_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.build_graph" class="md-nav__link">
    <span class="md-ellipsis">
      build_graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.format_query" class="md-nav__link">
    <span class="md-ellipsis">
      format_query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.format_result" class="md-nav__link">
    <span class="md-ellipsis">
      format_result
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.invoke" class="md-nav__link">
    <span class="md-ellipsis">
      invoke
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.ns" class="md-nav__link">
    <span class="md-ellipsis">
      ns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.write_state" class="md-nav__link">
    <span class="md-ellipsis">
      write_state
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.chat_agent" class="md-nav__link">
    <span class="md-ellipsis">
      chat_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="chat_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.chat_agent.ChatAgent" class="md-nav__link">
    <span class="md-ellipsis">
      ChatAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent" class="md-nav__link">
    <span class="md-ellipsis">
      code_review_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="code_review_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent.read_file" class="md-nav__link">
    <span class="md-ellipsis">
      read_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent.run_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_cmd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent.write_file" class="md-nav__link">
    <span class="md-ellipsis">
      write_file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent" class="md-nav__link">
    <span class="md-ellipsis">
      execution_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="execution_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionAgent" class="md-nav__link">
    <span class="md-ellipsis">
      ExecutionAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExecutionAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionAgent.query_executor" class="md-nav__link">
    <span class="md-ellipsis">
      query_executor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionAgent.recap" class="md-nav__link">
    <span class="md-ellipsis">
      recap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionState" class="md-nav__link">
    <span class="md-ellipsis">
      ExecutionState
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.command_safe" class="md-nav__link">
    <span class="md-ellipsis">
      command_safe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.should_continue" class="md-nav__link">
    <span class="md-ellipsis">
      should_continue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent" class="md-nav__link">
    <span class="md-ellipsis">
      hypothesizer_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="hypothesizer_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent" class="md-nav__link">
    <span class="md-ellipsis">
      HypothesizerAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HypothesizerAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.agent1_generate_solution" class="md-nav__link">
    <span class="md-ellipsis">
      agent1_generate_solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.agent2_critique" class="md-nav__link">
    <span class="md-ellipsis">
      agent2_critique
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.agent3_competitor_perspective" class="md-nav__link">
    <span class="md-ellipsis">
      agent3_competitor_perspective
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.generate_solution" class="md-nav__link">
    <span class="md-ellipsis">
      generate_solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.summarize_process_as_latex" class="md-nav__link">
    <span class="md-ellipsis">
      summarize_process_as_latex
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.lammps_agent" class="md-nav__link">
    <span class="md-ellipsis">
      lammps_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lammps_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.lammps_agent.LammpsAgent" class="md-nav__link">
    <span class="md-ellipsis">
      LammpsAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.mp_agent" class="md-nav__link">
    <span class="md-ellipsis">
      mp_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mp_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.mp_agent.MaterialsProjectAgent" class="md-nav__link">
    <span class="md-ellipsis">
      MaterialsProjectAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.optimization_agent" class="md-nav__link">
    <span class="md-ellipsis">
      optimization_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimization_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.optimization_agent.run_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_cmd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.optimization_agent.write_code" class="md-nav__link">
    <span class="md-ellipsis">
      write_code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent" class="md-nav__link">
    <span class="md-ellipsis">
      planning_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="planning_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent.PlanningAgent" class="md-nav__link">
    <span class="md-ellipsis">
      PlanningAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PlanningAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent.PlanningAgent.generation_node" class="md-nav__link">
    <span class="md-ellipsis">
      generation_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent.PlanningState" class="md-nav__link">
    <span class="md-ellipsis">
      PlanningState
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.websearch_agent" class="md-nav__link">
    <span class="md-ellipsis">
      websearch_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="websearch_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.websearch_agent.WebSearchAgentLegacy" class="md-nav__link">
    <span class="md-ellipsis">
      WebSearchAgentLegacy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.websearch_agent.process_content" class="md-nav__link">
    <span class="md-ellipsis">
      process_content
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prompt_library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    prompt_library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../util/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    util
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ursa.agents" class="md-nav__link">
    <span class="md-ellipsis">
      agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.__getattr__" class="md-nav__link">
    <span class="md-ellipsis">
      __getattr__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents" class="md-nav__link">
    <span class="md-ellipsis">
      acquisition_agents
    </span>
  </a>
  
    <nav class="md-nav" aria-label="acquisition_agents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.ArxivAgent" class="md-nav__link">
    <span class="md-ellipsis">
      ArxivAgent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.BaseAcquisitionAgent" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAcquisitionAgent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.OSTIAgent" class="md-nav__link">
    <span class="md-ellipsis">
      OSTIAgent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.acquisition_agents.WebSearchAgent" class="md-nav__link">
    <span class="md-ellipsis">
      WebSearchAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.base" class="md-nav__link">
    <span class="md-ellipsis">
      base
    </span>
  </a>
  
    <nav class="md-nav" aria-label="base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext" class="md-nav__link">
    <span class="md-ellipsis">
      AgentContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgentContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext.llm" class="md-nav__link">
    <span class="md-ellipsis">
      llm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext.tool_character_limit" class="md-nav__link">
    <span class="md-ellipsis">
      tool_character_limit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentContext.workspace" class="md-nav__link">
    <span class="md-ellipsis">
      workspace
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentWithTools" class="md-nav__link">
    <span class="md-ellipsis">
      AgentWithTools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgentWithTools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.AgentWithTools.add_mcp_tools" class="md-nav__link">
    <span class="md-ellipsis">
      add_mcp_tools
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.compiled_graph" class="md-nav__link">
    <span class="md-ellipsis">
      compiled_graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.context" class="md-nav__link">
    <span class="md-ellipsis">
      context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.name" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.storage" class="md-nav__link">
    <span class="md-ellipsis">
      storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.__init_subclass__" class="md-nav__link">
    <span class="md-ellipsis">
      __init_subclass__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.add_node" class="md-nav__link">
    <span class="md-ellipsis">
      add_node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.ainvoke" class="md-nav__link">
    <span class="md-ellipsis">
      ainvoke
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.build_config" class="md-nav__link">
    <span class="md-ellipsis">
      build_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.build_graph" class="md-nav__link">
    <span class="md-ellipsis">
      build_graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.format_query" class="md-nav__link">
    <span class="md-ellipsis">
      format_query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.format_result" class="md-nav__link">
    <span class="md-ellipsis">
      format_result
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.invoke" class="md-nav__link">
    <span class="md-ellipsis">
      invoke
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.ns" class="md-nav__link">
    <span class="md-ellipsis">
      ns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.base.BaseAgent.write_state" class="md-nav__link">
    <span class="md-ellipsis">
      write_state
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.chat_agent" class="md-nav__link">
    <span class="md-ellipsis">
      chat_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="chat_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.chat_agent.ChatAgent" class="md-nav__link">
    <span class="md-ellipsis">
      ChatAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent" class="md-nav__link">
    <span class="md-ellipsis">
      code_review_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="code_review_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent.read_file" class="md-nav__link">
    <span class="md-ellipsis">
      read_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent.run_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_cmd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.code_review_agent.write_file" class="md-nav__link">
    <span class="md-ellipsis">
      write_file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent" class="md-nav__link">
    <span class="md-ellipsis">
      execution_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="execution_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionAgent" class="md-nav__link">
    <span class="md-ellipsis">
      ExecutionAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExecutionAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionAgent.query_executor" class="md-nav__link">
    <span class="md-ellipsis">
      query_executor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionAgent.recap" class="md-nav__link">
    <span class="md-ellipsis">
      recap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.ExecutionState" class="md-nav__link">
    <span class="md-ellipsis">
      ExecutionState
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.command_safe" class="md-nav__link">
    <span class="md-ellipsis">
      command_safe
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.execution_agent.should_continue" class="md-nav__link">
    <span class="md-ellipsis">
      should_continue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent" class="md-nav__link">
    <span class="md-ellipsis">
      hypothesizer_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="hypothesizer_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent" class="md-nav__link">
    <span class="md-ellipsis">
      HypothesizerAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HypothesizerAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.agent1_generate_solution" class="md-nav__link">
    <span class="md-ellipsis">
      agent1_generate_solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.agent2_critique" class="md-nav__link">
    <span class="md-ellipsis">
      agent2_critique
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.agent3_competitor_perspective" class="md-nav__link">
    <span class="md-ellipsis">
      agent3_competitor_perspective
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.generate_solution" class="md-nav__link">
    <span class="md-ellipsis">
      generate_solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.hypothesizer_agent.HypothesizerAgent.summarize_process_as_latex" class="md-nav__link">
    <span class="md-ellipsis">
      summarize_process_as_latex
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.lammps_agent" class="md-nav__link">
    <span class="md-ellipsis">
      lammps_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lammps_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.lammps_agent.LammpsAgent" class="md-nav__link">
    <span class="md-ellipsis">
      LammpsAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.mp_agent" class="md-nav__link">
    <span class="md-ellipsis">
      mp_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mp_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.mp_agent.MaterialsProjectAgent" class="md-nav__link">
    <span class="md-ellipsis">
      MaterialsProjectAgent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.optimization_agent" class="md-nav__link">
    <span class="md-ellipsis">
      optimization_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimization_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.optimization_agent.run_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_cmd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.optimization_agent.write_code" class="md-nav__link">
    <span class="md-ellipsis">
      write_code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent" class="md-nav__link">
    <span class="md-ellipsis">
      planning_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="planning_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent.PlanningAgent" class="md-nav__link">
    <span class="md-ellipsis">
      PlanningAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PlanningAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent.PlanningAgent.generation_node" class="md-nav__link">
    <span class="md-ellipsis">
      generation_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.planning_agent.PlanningState" class="md-nav__link">
    <span class="md-ellipsis">
      PlanningState
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ursa.agents.websearch_agent" class="md-nav__link">
    <span class="md-ellipsis">
      websearch_agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="websearch_agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ursa.agents.websearch_agent.WebSearchAgentLegacy" class="md-nav__link">
    <span class="md-ellipsis">
      WebSearchAgentLegacy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ursa.agents.websearch_agent.process_content" class="md-nav__link">
    <span class="md-ellipsis">
      process_content
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>agents</h1>

<div class="doc doc-object doc-module">



<a id="ursa.agents"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ursa.agents.__getattr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Dynamically import attributes on first access.</p>
<p>This avoids importing all agent modules at package import time,
so a failure in one agent does not prevent using others.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dynamically import attributes on first access.</span>

<span class="sd">    This avoids importing all agent modules at package import time,</span>
<span class="sd">    so a failure in one agent does not prevent using others.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module_name</span><span class="p">,</span> <span class="n">attr_name</span> <span class="o">=</span> <span class="n">_lazy_attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;module </span><span class="si">{</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> has no attribute </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
    <span class="c1"># Cache the loaded attribute so subsequent access is fast</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>


<div class="doc doc-object doc-module">



<h2 id="ursa.agents.acquisition_agents" class="doc doc-heading">
            <code>acquisition_agents</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.acquisition_agents.ArxivAgent" class="doc doc-heading">
            <code>ArxivAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAcquisitionAgent (ursa.agents.acquisition_agents.BaseAcquisitionAgent)" href="#ursa.agents.acquisition_agents.BaseAcquisitionAgent">BaseAcquisitionAgent</a></code></p>


        <p>Drop-in replacement for your existing ArxivAgent that reuses the generic flow.
Keeps the same behaviors (download PDFs, image processing, summarization/RAG).</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/acquisition_agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ArxivAgent</span><span class="p">(</span><span class="n">BaseAcquisitionAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop-in replacement for your existing ArxivAgent that reuses the generic flow.</span>
<span class="sd">    Keeps the same behaviors (download PDFs, image processing, summarization/RAG).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">process_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">rag_embedding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">database_path</span><span class="o">=</span><span class="s2">&quot;arxiv_papers&quot;</span><span class="p">,</span>
        <span class="n">summaries_path</span><span class="o">=</span><span class="s2">&quot;arxiv_generated_summaries&quot;</span><span class="p">,</span>
        <span class="n">vectorstore_path</span><span class="o">=</span><span class="s2">&quot;arxiv_vectorstores&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">llm</span><span class="p">,</span>
            <span class="n">rag_embedding</span><span class="o">=</span><span class="n">rag_embedding</span><span class="p">,</span>
            <span class="n">process_images</span><span class="o">=</span><span class="n">process_images</span><span class="p">,</span>
            <span class="n">max_results</span><span class="o">=</span><span class="n">max_results</span><span class="p">,</span>
            <span class="n">database_path</span><span class="o">=</span><span class="n">database_path</span><span class="p">,</span>
            <span class="n">summaries_path</span><span class="o">=</span><span class="n">summaries_path</span><span class="p">,</span>
            <span class="n">vectorstore_path</span><span class="o">=</span><span class="n">vectorstore_path</span><span class="p">,</span>
            <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit_or_item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># hits from arXiv feed have &#39;id&#39; like &quot;.../abs/XXXX.YYYY&quot;</span>
        <span class="n">arxiv_id</span> <span class="o">=</span> <span class="n">hit_or_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arxiv_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arxiv_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arxiv_id</span>
        <span class="n">feed_id</span> <span class="o">=</span> <span class="n">hit_or_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;/abs/&quot;</span> <span class="ow">in</span> <span class="n">feed_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">feed_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/abs/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">hit_or_item</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">ItemMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ArXiv ID: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://export.arxiv.org/api/query?search_query=all:</span><span class="si">{</span><span class="n">enc</span><span class="si">}</span><span class="s2">&amp;start=0&amp;max_results=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_results</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">feed</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">entries</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="s2">&quot;entries&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="n">full_id</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/abs/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="s2">&quot;arxiv_id&quot;</span><span class="p">:</span> <span class="n">full_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">})</span>
            <span class="k">return</span> <span class="n">hits</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">_hash</span><span class="p">(</span><span class="n">query</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span>
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Search error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_materialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ItemMetadata</span><span class="p">:</span>
        <span class="n">arxiv_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">pdf_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://arxiv.org/pdf/</span><span class="si">{</span><span class="n">arxiv_id</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arxiv_id</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
        <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_download</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Error loading ArXiv </span><span class="si">{</span><span class="n">arxiv_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="n">full_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_text</span><span class="p">(</span><span class="n">full_text</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">arxiv_id</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">pdf_url</span><span class="p">,</span>
            <span class="s2">&quot;local_path&quot;</span><span class="p">:</span> <span class="n">local_path</span><span class="p">,</span>
            <span class="s2">&quot;full_text&quot;</span><span class="p">:</span> <span class="n">full_text</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ursa.agents.acquisition_agents.BaseAcquisitionAgent" class="doc doc-heading">
            <code>BaseAcquisitionAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a></code></p>


        <p>A generic "acquire-then-summarize-or-RAG" agent.</p>


<details class="subclasses-must-implement" open>
  <summary>Subclasses must implement</summary>
  <ul>
<li>_search(self, query) -&gt; List[dict-like]: lightweight hits</li>
<li>_materialize(self, hit) -&gt; ItemMetadata: download or scrape and return populated item</li>
<li>_id(self, hit_or_item) -&gt; str: stable id for caching/file naming</li>
<li>_citation(self, item) -&gt; str: human-readable citation string</li>
</ul>
</details>

<details class="optional-hooks" open>
  <summary>Optional hooks</summary>
  <ul>
<li>_postprocess_text(self, text, local_path) -&gt; str (e.g., image interpretation)</li>
<li>_filter_hit(self, hit) -&gt; bool</li>
</ul>
</details>







              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/acquisition_agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseAcquisitionAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A generic &quot;acquire-then-summarize-or-RAG&quot; agent.</span>

<span class="sd">    Subclasses must implement:</span>
<span class="sd">      - _search(self, query) -&gt; List[dict-like]: lightweight hits</span>
<span class="sd">      - _materialize(self, hit) -&gt; ItemMetadata: download or scrape and return populated item</span>
<span class="sd">      - _id(self, hit_or_item) -&gt; str: stable id for caching/file naming</span>
<span class="sd">      - _citation(self, item) -&gt; str: human-readable citation string</span>

<span class="sd">    Optional hooks:</span>
<span class="sd">      - _postprocess_text(self, text, local_path) -&gt; str (e.g., image interpretation)</span>
<span class="sd">      - _filter_hit(self, hit) -&gt; bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">summarize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">rag_embedding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">process_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acq_db&quot;</span><span class="p">,</span>
        <span class="n">summaries_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acq_summaries&quot;</span><span class="p">,</span>
        <span class="n">vectorstore_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;acq_vectorstores&quot;</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span> <span class="o">=</span> <span class="n">summarize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rag_embedding</span> <span class="o">=</span> <span class="n">rag_embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_images</span> <span class="o">=</span> <span class="n">process_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_results</span> <span class="o">=</span> <span class="n">max_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">/</span> <span class="n">database_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">/</span> <span class="n">summaries_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vectorstore_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">/</span> <span class="n">vectorstore_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download</span> <span class="o">=</span> <span class="n">download</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span> <span class="o">=</span> <span class="n">num_threads</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># ---- abstract-ish methods ----</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_materialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ItemMetadata</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit_or_item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">ItemMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Subclass should format its ideal citation; fallback is ID or URL.</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown Source&quot;</span><span class="p">)</span>

    <span class="c1"># ---- optional hooks ----</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_hit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_postprocess_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Default: optionally add image descriptions for PDFs</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_images</span>
            <span class="ow">and</span> <span class="n">local_path</span>
            <span class="ow">and</span> <span class="n">local_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">descs</span> <span class="o">=</span> <span class="n">extract_and_describe_images</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">descs</span><span class="p">):</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">[Image Interpretations]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">descs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="c1"># ---- shared nodes ----</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ItemMetadata</span><span class="p">]:</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">query</span><span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_results</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ItemMetadata</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If not downloading/scraping, try to load whatever is cached in database_path.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;.html&quot;</span><span class="p">)):</span>
                    <span class="n">item_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
                            <span class="n">full_text</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                                <span class="n">local_path</span><span class="p">,</span>
                                <span class="s2">&quot;r&quot;</span><span class="p">,</span>
                                <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
                                <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">full_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">full_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Error reading cached file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="n">full_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_text</span><span class="p">(</span><span class="n">full_text</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">,</span>
                        <span class="s2">&quot;local_path&quot;</span><span class="p">:</span> <span class="n">local_path</span><span class="p">,</span>
                        <span class="s2">&quot;full_text&quot;</span><span class="p">:</span> <span class="n">full_text</span><span class="p">,</span>
                    <span class="p">})</span>
            <span class="k">return</span> <span class="n">items</span>

        <span class="c1"># Normal path: search  materialize each</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)))</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_materialize</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hits</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_hit</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">_hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span>
                        <span class="s2">&quot;full_text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
        <span class="k">return</span> <span class="n">items</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AcquisitionState</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AcquisitionState</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">inputs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid input for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AcquisitionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">summary</span> <span class="o">:=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;final_summary&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">summary</span>

        <span class="c1"># Fallback to dumping an empty string if `self.summarize=False`.</span>
        <span class="c1"># This only happens if a user disables summarization when configuring</span>
        <span class="c1"># URSA or if the final_summary is an empty string itself.</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_search_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AcquisitionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AcquisitionState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a search query from the input search task (context)&quot;&quot;&quot;</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The user stated </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">. Generate between 1 and 8 words for a search query to address the users need. Return only the words to search.&quot;</span>
        <span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="n">context</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AcquisitionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AcquisitionState</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_items</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AcquisitionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AcquisitionState</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        You are an assistant responsible for summarizing retrieved content in the context of this task: </span><span class="si">{context}</span>

<span class="s2">        Summarize the content below:</span>

<span class="s2">        </span><span class="si">{retrieved_content}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;items&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;summaries&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="n">summaries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">ItemMetadata</span><span class="p">):</span>
            <span class="n">item_id</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;item_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_safe_filename</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span><span class="si">}</span><span class="s2">_summary.txt&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="n">remove_surrogates</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;full_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;retrieved_content&quot;</span><span class="p">:</span> <span class="n">cleaned</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]},</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acq&quot;</span><span class="p">,</span> <span class="s2">&quot;summarize_each&quot;</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Error summarizing item </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">summary</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]))</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">summaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;summaries&quot;</span><span class="p">:</span> <span class="n">summaries</span><span class="p">}</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rag_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AcquisitionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AcquisitionState</span><span class="p">:</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rag_agent</span> <span class="o">=</span> <span class="n">RAGAgent</span><span class="p">(</span>
            <span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span>
            <span class="n">workspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rag_embedding</span><span class="p">,</span>
            <span class="n">vectorstore_path</span><span class="o">=</span><span class="s2">&quot;rag_vectorstore&quot;</span><span class="p">,</span>
            <span class="n">database_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;final_summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rag_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">])[</span>
            <span class="s2">&quot;summary&quot;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">new_state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AcquisitionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AcquisitionState</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summaries&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;final_summary&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="n">blocks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">summ</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;summaries&quot;</span><span class="p">])</span>
        <span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="n">cite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_citation</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">cite</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">summ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span><span class="p">,</span> <span class="s2">&quot;summaries_combined.txt&quot;</span><span class="p">),</span>
            <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        You are a scientific assistant extracting insights from multiple summaries.</span>

<span class="s2">        Here are the summaries:</span>

<span class="s2">        </span><span class="si">{Summaries}</span>

<span class="s2">        Your task is to read all the summaries and provide a response to this task: </span><span class="si">{context}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>

        <span class="n">final_summary</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;Summaries&quot;</span><span class="p">:</span> <span class="n">combined</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]},</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acq&quot;</span><span class="p">,</span> <span class="s2">&quot;aggregate&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span><span class="p">,</span> <span class="s2">&quot;final_summary.txt&quot;</span><span class="p">),</span>
            <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_summary</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;final_summary&quot;</span><span class="p">:</span> <span class="n">final_summary</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;_search_query&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_search_query&quot;</span><span class="p">,</span> <span class="s2">&quot;_fetch_node&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_embedding</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rag_node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_fetch_node&quot;</span><span class="p">,</span> <span class="s2">&quot;_rag_node&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;_rag_node&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summarize_node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_node</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_fetch_node&quot;</span><span class="p">,</span> <span class="s2">&quot;_summarize_node&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_summarize_node&quot;</span><span class="p">,</span> <span class="s2">&quot;_aggregate_node&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;_aggregate_node&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;_fetch_node&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ursa.agents.acquisition_agents.OSTIAgent" class="doc doc-heading">
            <code>OSTIAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAcquisitionAgent (ursa.agents.acquisition_agents.BaseAcquisitionAgent)" href="#ursa.agents.acquisition_agents.BaseAcquisitionAgent">BaseAcquisitionAgent</a></code></p>


        <p>Minimal OSTI.gov acquisition agent.</p>


<details class="note" open>
  <summary>NOTE</summary>
  <ul>
<li>OSTI provides search endpoints that can return metadata including full-text links.</li>
<li>Depending on your environment, you may prefer the public API or site scraping.</li>
<li>Here we assume a JSON API that yields results with keys like:
      {'osti_id': '12345', 'title': '...', 'pdf_url': 'https://...pdf', 'landing_page': 'https://...'}
  Adapt field names if your OSTI integration differs.</li>
</ul>
</details>        <p>Customize <code>_search</code> and <code>_materialize</code> to match your OSTI access path.</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/acquisition_agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OSTIAgent</span><span class="p">(</span><span class="n">BaseAcquisitionAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Minimal OSTI.gov acquisition agent.</span>

<span class="sd">    NOTE:</span>
<span class="sd">      - OSTI provides search endpoints that can return metadata including full-text links.</span>
<span class="sd">      - Depending on your environment, you may prefer the public API or site scraping.</span>
<span class="sd">      - Here we assume a JSON API that yields results with keys like:</span>
<span class="sd">            {&#39;osti_id&#39;: &#39;12345&#39;, &#39;title&#39;: &#39;...&#39;, &#39;pdf_url&#39;: &#39;https://...pdf&#39;, &#39;landing_page&#39;: &#39;https://...&#39;}</span>
<span class="sd">        Adapt field names if your OSTI integration differs.</span>

<span class="sd">    Customize `_search` and `_materialize` to match your OSTI access path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">api_base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://www.osti.gov/api/v1/records&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_base</span> <span class="o">=</span> <span class="n">api_base</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit_or_item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;osti_id&quot;</span> <span class="ow">in</span> <span class="n">hit_or_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">hit_or_item</span><span class="p">[</span><span class="s2">&quot;osti_id&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">hit_or_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">hit_or_item</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;landing_page&quot;</span> <span class="ow">in</span> <span class="n">hit_or_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">hit_or_item</span><span class="p">[</span><span class="s2">&quot;landing_page&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">hit_or_item</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">ItemMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">oid</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;OSTI </span><span class="si">{</span><span class="n">oid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">t</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;OSTI </span><span class="si">{</span><span class="n">oid</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust params to your OSTI setup. This call is intentionally simple;</span>
<span class="sd">        add paging/auth as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_results</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_base</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="c1"># Normalize to a list of hits; adapt key if your API differs.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;records&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;records&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="n">hits</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">_hash</span><span class="p">(</span><span class="n">query</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span>
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Search error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_materialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ItemMetadata</span><span class="p">:</span>
        <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title_public&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">landing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pdf_url</span><span class="p">,</span> <span class="n">landing_used</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">resolve_pdf_from_osti_record</span><span class="p">(</span>
                <span class="n">hit</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">},</span>
                <span class="n">unpaywall_email</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UNPAYWALL_EMAIL&quot;</span><span class="p">),</span>  <span class="c1"># optional</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">pdf_url</span><span class="p">:</span>
                <span class="c1"># Try to download as PDF (validate headers)</span>
                <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">pdf_url</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">},</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                    <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">_is_pdf_response</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">_derive_filename_from_cd_or_url</span><span class="p">(</span>
                            <span class="n">r</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;osti_</span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
                        <span class="p">)</span>
                        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                        <span class="n">_download_stream_to</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                        <span class="c1"># Extract PDF text</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">full_text</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">full_text</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;[Downloaded but text extraction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Not a PDF; treat as HTML landing and parse text</span>
                        <span class="n">landing</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># If we still have no text, try scraping the DOE PAGES landing or citation page</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_text</span><span class="p">:</span>
                <span class="c1"># Prefer DOE PAGES landing if present, else OSTI biblio</span>
                <span class="n">landing</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">landing</span>
                    <span class="ow">or</span> <span class="n">landing_used</span>
                    <span class="ow">or</span> <span class="nb">next</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">,</span> <span class="p">[])</span>
                            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span>
                            <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;citation_doe_pages&quot;</span><span class="p">,</span> <span class="s2">&quot;citation&quot;</span><span class="p">)</span>
                        <span class="p">),</span>
                        <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">landing</span><span class="p">:</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">_get_soup</span><span class="p">(</span>
                        <span class="n">landing</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">},</span>
                    <span class="p">)</span>
                    <span class="n">html_text</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">full_text</span> <span class="o">=</span> <span class="n">html_text</span><span class="p">[:</span><span class="mi">1_000_000</span><span class="p">]</span>  <span class="c1"># keep it bounded</span>
                    <span class="c1"># Save raw HTML for cache/inspection</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">.html&quot;</span>
                    <span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot;[No PDF or landing page text available.]&quot;</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Error materializing OSTI </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">full_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_text</span><span class="p">(</span><span class="n">full_text</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">landing</span><span class="p">,</span>
            <span class="s2">&quot;local_path&quot;</span><span class="p">:</span> <span class="n">local_path</span><span class="p">,</span>
            <span class="s2">&quot;full_text&quot;</span><span class="p">:</span> <span class="n">full_text</span><span class="p">,</span>
            <span class="s2">&quot;extra&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;raw_hit&quot;</span><span class="p">:</span> <span class="n">hit</span><span class="p">},</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ursa.agents.acquisition_agents.WebSearchAgent" class="doc doc-heading">
            <code>WebSearchAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAcquisitionAgent (ursa.agents.acquisition_agents.BaseAcquisitionAgent)" href="#ursa.agents.acquisition_agents.BaseAcquisitionAgent">BaseAcquisitionAgent</a></code></p>


        <p>Uses DuckDuckGo Search (ddgs) to find pages, downloads HTML or PDFs,
extracts text, and then follows the same summarize/RAG path.</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/acquisition_agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WebSearchAgent</span><span class="p">(</span><span class="n">BaseAcquisitionAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses DuckDuckGo Search (ddgs) to find pages, downloads HTML or PDFs,</span>
<span class="sd">    extracts text, and then follows the same summarize/RAG path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">=</span> <span class="n">user_agent</span>
        <span class="k">if</span> <span class="n">DDGS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;duckduckgo-search (DDGS) is required for WebSearchAgentGeneric.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit_or_item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">hit_or_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">hit_or_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">_hash</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">url</span>
            <span class="k">else</span> <span class="n">hit_or_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">_hash</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">hit_or_item</span><span class="p">)))</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">ItemMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">t</span> <span class="k">else</span> <span class="p">(</span><span class="n">u</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;Web result&quot;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">DDGS</span><span class="p">()</span> <span class="k">as</span> <span class="n">ddgs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ddgs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_results</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
            <span class="p">):</span>
                <span class="c1"># r keys typically: title, href, body</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_materialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ItemMetadata</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">(</span><span class="n">hit</span><span class="p">),</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;full_text&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span><span class="p">}</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_looks_like_pdf_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="n">_safe_filename</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span>
                <span class="p">)</span>
                <span class="n">_download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
                <span class="n">full_text</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">html</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="n">_safe_filename</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.html&quot;</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
                <span class="n">full_text</span> <span class="o">=</span> <span class="n">extract_main_text_only</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
                <span class="c1"># full_text = _basic_readable_text_from_html(html)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Error retrieving </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">full_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_text</span><span class="p">(</span><span class="n">full_text</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;local_path&quot;</span><span class="p">:</span> <span class="n">local_path</span><span class="p">,</span>
            <span class="s2">&quot;full_text&quot;</span><span class="p">:</span> <span class="n">full_text</span><span class="p">,</span>
            <span class="s2">&quot;extra&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;snippet&quot;</span><span class="p">:</span> <span class="n">hit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)},</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.base" class="doc doc-heading">
            <code>base</code>


</h2>

    <div class="doc doc-contents ">

        <p>Base agent class providing telemetry, configuration, and execution abstractions.</p>
<p>This module defines the BaseAgent abstract class, which serves as the foundation for all
agent implementations in the Ursa framework. It provides:</p>
<ul>
<li>Standardized initialization with LLM configuration</li>
<li>Telemetry and metrics collection</li>
<li>Thread and checkpoint management</li>
<li>Input normalization and validation</li>
<li>Execution flow control with invoke/stream methods</li>
<li>Graph integration utilities for LangGraph compatibility</li>
<li>Runtime enforcement of the agent interface contract</li>
</ul>
<p>Agents built on this base class benefit from consistent behavior, observability, and
integration capabilities while only needing to implement the core _invoke method.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.base.AgentContext" class="doc doc-heading">
            <code>AgentContext</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Immutable context provided during graph execution</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Immutable context provided during graph execution&quot;&quot;&quot;</span>

    <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Chat model for use during tool calls &quot;&quot;&quot;</span>

    <span class="n">workspace</span><span class="p">:</span> <span class="n">Path</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Workspace path for the agent &quot;&quot;&quot;</span>

    <span class="n">tool_character_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30000</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Suggested limit on tool call responses &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="ursa.agents.base.AgentContext.llm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">llm</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Chat model for use during tool calls</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="ursa.agents.base.AgentContext.tool_character_limit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tool_character_limit</span> <span class="o">=</span> <span class="mi">30000</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Suggested limit on tool call responses</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="ursa.agents.base.AgentContext.workspace" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">workspace</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Workspace path for the agent</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ursa.agents.base.AgentWithTools" class="doc doc-heading">
            <code>AgentWithTools</code>


</h3>


    <div class="doc doc-contents ">


        <p>Mixin that equips an agent with LangGraph tools management.</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AgentWithTools</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin that equips an agent with LangGraph tools management.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">handle_tool_errors</span><span class="o">=</span><span class="n">_default_tool_error_handler</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_tool_errors</span> <span class="o">=</span> <span class="n">handle_tool_errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_node</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">rebuild_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="p">)</span>

    <span class="nd">@tools</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">BaseTool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="n">tools</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">tools</span><span class="p">]</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="p">)</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">bundle</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_tools</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_mcp_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">MultiServerMCPClient</span><span class="p">,</span>
        <span class="n">tool_name</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tools from an MCP client to the agent</span>

<span class="sd">        Args:</span>
<span class="sd">           client: the MCP client to add tools from</span>
<span class="sd">           tool_name: if provided, only add named tools</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tools</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">tool_name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span> <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tool_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tool</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_names</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">tool_names</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">tool_names</span><span class="p">]</span>
        <span class="n">trimmed</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">tool</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_tools</span><span class="p">(</span><span class="n">trimmed</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rebuild_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span> <span class="o">=</span> <span class="n">mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_node</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tools</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">handle_tool_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_tool_errors</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">rebuild_graph</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;build_graph&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;compiled_graph&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.AgentWithTools.add_mcp_tools" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_mcp_tools</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tool_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Add tools from an MCP client to the agent</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>client</code>
            </td>
            <td>
                  <code><span title="langchain_mcp_adapters.client.MultiServerMCPClient">MultiServerMCPClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the MCP client to add tools from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_name</code>
            </td>
            <td>
                  <code>None | <span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if provided, only add named tools</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_mcp_tools</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">MultiServerMCPClient</span><span class="p">,</span>
    <span class="n">tool_name</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add tools from an MCP client to the agent</span>

<span class="sd">    Args:</span>
<span class="sd">       client: the MCP client to add tools from</span>
<span class="sd">       tool_name: if provided, only add named tools</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_tools</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tool_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tool_name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span> <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tool_name</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_tool</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ursa.agents.base.BaseAgent" class="doc doc-heading">
            <code>BaseAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Generic">Generic</span>[<span title="ursa.agents.base.TState">TState</span>]</code>, <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for all agent implementations in the Ursa framework.</p>
<p>BaseAgent provides a standardized foundation for building LLM-powered agents with
built-in telemetry, configuration management, and execution flow control. It handles
common tasks like input normalization, thread management, metrics collection, and
LangGraph integration.</p>
<p>Subclasses only need to implement the _invoke method to define their core
functionality, while inheriting standardized invocation patterns, telemetry, and
graph integration capabilities. The class enforces a consistent interface through
runtime checks that prevent subclasses from overriding critical methods like
invoke().</p>
<p>The agent supports both direct invocation with inputs and streaming responses, with
automatic tracking of token usage, execution time, and other metrics. It also
provides utilities for integrating with LangGraph through node wrapping and
configuration.</p>


<details class="subclass-inheritance-guidelines" open>
  <summary>Subclass Inheritance Guidelines</summary>
  <ul>
<li>Must Override: _invoke() - Define your agent's core functionality</li>
<li>Can Override: _stream() - Enable streaming support
                _normalize_inputs() - Customize input handling
                Various helper methods (_default_node_tags, etc.)</li>
<li>Never Override: invoke() - Final method with runtime enforcement
                  stream() - Handles telemetry and delegates to _stream
                  <strong>call</strong>() - Delegates to invoke
                  Other public methods (build_config, write_state, add_node)</li>
</ul>
</details>        <p>To create a custom agent, inherit from this class and implement the _invoke method:</p>
<pre><code class="language-python">class MyAgent(BaseAgent):
    def _invoke(self, inputs: Mapping[str, Any], **config: Any) -&gt; Any:
        # Process inputs and return results
        ...
</code></pre>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseAgent</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">TState</span><span class="p">],</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for all agent implementations in the Ursa framework.</span>

<span class="sd">    BaseAgent provides a standardized foundation for building LLM-powered agents with</span>
<span class="sd">    built-in telemetry, configuration management, and execution flow control. It handles</span>
<span class="sd">    common tasks like input normalization, thread management, metrics collection, and</span>
<span class="sd">    LangGraph integration.</span>

<span class="sd">    Subclasses only need to implement the _invoke method to define their core</span>
<span class="sd">    functionality, while inheriting standardized invocation patterns, telemetry, and</span>
<span class="sd">    graph integration capabilities. The class enforces a consistent interface through</span>
<span class="sd">    runtime checks that prevent subclasses from overriding critical methods like</span>
<span class="sd">    invoke().</span>

<span class="sd">    The agent supports both direct invocation with inputs and streaming responses, with</span>
<span class="sd">    automatic tracking of token usage, execution time, and other metrics. It also</span>
<span class="sd">    provides utilities for integrating with LangGraph through node wrapping and</span>
<span class="sd">    configuration.</span>

<span class="sd">    Subclass Inheritance Guidelines:</span>
<span class="sd">        - Must Override: _invoke() - Define your agent&#39;s core functionality</span>
<span class="sd">        - Can Override: _stream() - Enable streaming support</span>
<span class="sd">                        _normalize_inputs() - Customize input handling</span>
<span class="sd">                        Various helper methods (_default_node_tags, etc.)</span>
<span class="sd">        - Never Override: invoke() - Final method with runtime enforcement</span>
<span class="sd">                          stream() - Handles telemetry and delegates to _stream</span>
<span class="sd">                          __call__() - Delegates to invoke</span>
<span class="sd">                          Other public methods (build_config, write_state, add_node)</span>

<span class="sd">    To create a custom agent, inherit from this class and implement the _invoke method:</span>

<span class="sd">    ```python</span>
<span class="sd">    class MyAgent(BaseAgent):</span>
<span class="sd">        def _invoke(self, inputs: Mapping[str, Any], **config: Any) -&gt; Any:</span>
<span class="sd">            # Process inputs and return results</span>
<span class="sd">            ...</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># This will be shared across all BaseAgent instances.</span>
    <span class="n">_invoke_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">_TELEMETRY_KW</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;raw_debug&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_otel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metrics_path&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_raw_snapshot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_raw_records&quot;</span><span class="p">,</span>
        <span class="s2">&quot;otel_endpoint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;otel_headers&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">_CONTROL_KW</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;recursion_limit&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;callbacks&quot;</span><span class="p">}</span>

    <span class="n">state_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">TState</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="n">workspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">checkpointer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseCheckpointSaver</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">metrics_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ursa_metrics&quot;</span><span class="p">,</span>  <span class="c1"># dir to save metrics, with a default</span>
        <span class="n">autosave_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">otel_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">thread_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the base agent with a language model and optional configurations.</span>

<span class="sd">        Args:</span>
<span class="sd">            llm: a BaseChatModel instance.</span>
<span class="sd">            checkpointer: Optional checkpoint saver for persisting agent state.</span>
<span class="sd">            enable_metrics: Whether to collect performance and usage metrics.</span>
<span class="sd">            metrics_dir: Directory path where metrics will be saved.</span>
<span class="sd">            autosave_metrics: Whether to automatically save metrics to disk.</span>
<span class="sd">            thread_id: Unique identifier for this agent instance. Generated if not</span>
<span class="sd">                       provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span> <span class="o">=</span> <span class="n">llm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">workspace</span> <span class="ow">or</span> <span class="s2">&quot;ursa_workspace&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">thread_id</span> <span class="ow">or</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpointer</span> <span class="o">=</span> <span class="n">checkpointer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span> <span class="o">=</span> <span class="n">Telemetry</span><span class="p">(</span>
            <span class="n">enable</span><span class="o">=</span><span class="n">enable_metrics</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">metrics_dir</span><span class="p">),</span>
            <span class="n">save_json_default</span><span class="o">=</span><span class="n">autosave_metrics</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Agent name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentContext</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Immutable run-scoped information provided to the Agent&#39;s graph&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AgentContext</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">node_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">agent_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateGraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a node to the state graph with token usage tracking.</span>

<span class="sd">        This method adds a function as a node to the state graph, wrapping it to track</span>
<span class="sd">        token usage during execution. The node is identified by either the provided</span>
<span class="sd">        node_name or the function&#39;s name.</span>

<span class="sd">        Args:</span>
<span class="sd">            f: The function to add as a node. Should return a mapping of string keys to</span>
<span class="sd">                any values.</span>
<span class="sd">            node_name: Optional name for the node. If not provided, the function&#39;s name</span>
<span class="sd">                will be used.</span>
<span class="sd">            agent_name: Optional agent name for tracking. If not provided, the agent&#39;s</span>
<span class="sd">                name in snake_case will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The updated StateGraph with the new node added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_node_name</span> <span class="o">=</span> <span class="n">node_name</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">_agent_name</span> <span class="o">=</span> <span class="n">agent_name</span> <span class="ow">or</span> <span class="n">_to_snake</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wrapped_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_node</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_node_name</span><span class="p">,</span> <span class="n">_agent_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">_node_name</span><span class="p">,</span> <span class="n">wrapped_node</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes agent state to a JSON file.</span>

<span class="sd">        Serializes the provided state dictionary to JSON format and writes it to the</span>
<span class="sd">        specified file. The JSON is written with non-ASCII characters preserved.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Path to the file where state will be written.</span>
<span class="sd">            state: Dictionary containing the agent state to be serialized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_state</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_state</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs a config dictionary for agent operations with telemetry support.</span>

<span class="sd">        This method creates a standardized configuration dictionary that includes thread</span>
<span class="sd">        identification, telemetry callbacks, and other metadata needed for agent</span>
<span class="sd">        operations. The configuration can be customized through override parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            **overrides: Optional configuration overrides that can include keys like</span>
<span class="sd">                &#39;recursion_limit&#39;, &#39;configurable&#39;, &#39;metadata&#39;, &#39;tags&#39;, etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A complete configuration dictionary with all necessary parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the base configuration with essential fields.</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span><span class="p">},</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span><span class="p">,</span>
                <span class="s2">&quot;telemetry_run_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id&quot;</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
            <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Try to determine the model name from either direct or nested attributes</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;llm_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;llm&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># Add model name to metadata if available</span>
        <span class="k">if</span> <span class="n">model_name</span><span class="p">:</span>
            <span class="n">base</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_name</span>

        <span class="c1"># Handle configurable dictionary overrides by merging with base configurable</span>
        <span class="k">if</span> <span class="s2">&quot;configurable&quot;</span> <span class="ow">in</span> <span class="n">overrides</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">],</span> <span class="nb">dict</span>
        <span class="p">):</span>
            <span class="n">base</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;configurable&quot;</span><span class="p">))</span>

        <span class="c1"># Handle metadata dictionary overrides by merging with base metadata</span>
        <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">overrides</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">base</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">))</span>

        <span class="c1"># Merge tags from caller-provided overrides, avoid duplicates</span>
        <span class="k">if</span> <span class="s2">&quot;tags&quot;</span> <span class="ow">in</span> <span class="n">overrides</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">base</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">overrides</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="c1"># Apply any remaining overrides directly to the base configuration</span>
        <span class="n">base</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">base</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_invoke_engine</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">invoke_method</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InputLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raw_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_otel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">otel_endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">otel_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_records</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start telemetry tracking for the top-level invocation</span>
            <span class="k">if</span> <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">begin_run</span><span class="p">(</span>
                    <span class="n">agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span>
                <span class="p">)</span>

            <span class="c1"># Handle the case where inputs are provided as keyword arguments</span>
            <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Separate kwargs into input parameters and control parameters</span>
                <span class="n">kw_inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">control_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TELEMETRY_KW</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONTROL_KW</span><span class="p">:</span>
                        <span class="n">control_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kw_inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">kw_inputs</span>

                <span class="c1"># Only control kwargs remain for further processing</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">control_kwargs</span>

            <span class="c1"># Handle the case where inputs are provided as a positional argument</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ensure no ambiguous keyword arguments are present</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TELEMETRY_KW</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONTROL_KW</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unexpected keyword argument &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                            <span class="s2">&quot;Pass inputs as a single mapping or omit the positional &quot;</span>
                            <span class="s2">&quot;inputs and pass them as keyword arguments.&quot;</span>
                        <span class="p">)</span>

            <span class="c1"># Allow subclasses to normalize or transform the input format</span>
            <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

            <span class="c1"># Delegate to the subclass implementation with the normalized inputs</span>
            <span class="c1"># and any control parameters</span>
            <span class="k">return</span> <span class="n">invoke_method</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clean up the invocation depth tracking</span>
            <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="c1"># For the top-level invocation, finalize telemetry and generate outputs</span>
            <span class="k">if</span> <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">raw</span><span class="o">=</span><span class="n">raw_debug</span><span class="p">,</span>
                    <span class="n">save_json</span><span class="o">=</span><span class="n">save_json</span><span class="p">,</span>
                    <span class="n">save_otel</span><span class="o">=</span><span class="n">save_otel</span><span class="p">,</span>
                    <span class="n">filepath</span><span class="o">=</span><span class="n">metrics_path</span><span class="p">,</span>
                    <span class="n">otel_endpoint</span><span class="o">=</span><span class="n">otel_endpoint</span><span class="p">,</span>
                    <span class="n">otel_headers</span><span class="o">=</span><span class="n">otel_headers</span><span class="p">,</span>
                    <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="n">save_raw_snapshot</span><span class="p">,</span>
                    <span class="n">save_raw_records</span><span class="o">=</span><span class="n">save_raw_records</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># NOTE: The `invoke` method uses the PEP 570 `/,*` notation to explicitly state which</span>
    <span class="c1"># arguments can and cannot be passed as positional or keyword arguments.</span>
    <span class="nd">@final</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InputLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">raw_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_otel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_records</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes the agent with the provided inputs and configuration.</span>

<span class="sd">        This is the main entry point for agent execution. It handles input normalization,</span>
<span class="sd">        telemetry tracking, and proper execution context management. The method supports</span>
<span class="sd">        flexible input formats - either as a positional argument or as keyword arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: Optional positional input to the agent. If provided, all non-control</span>
<span class="sd">                keyword arguments will be rejected to avoid ambiguity.</span>
<span class="sd">            raw_debug: If True, displays raw telemetry data for debugging purposes.</span>
<span class="sd">            save_json: If True, saves telemetry data as JSON.</span>
<span class="sd">            save_otel: If True, saves telemetry data to OpenTelemetry endpoint.</span>
<span class="sd">            metrics_path: Optional file path where telemetry metrics should be saved.</span>
<span class="sd">            save_raw_snapshot: If True, saves a raw snapshot of the telemetry data.</span>
<span class="sd">            save_raw_records: If True, saves raw telemetry records.</span>
<span class="sd">            config: Optional configuration dictionary to override default settings.</span>
<span class="sd">            **kwargs: Additional keyword arguments that can be either:</span>
<span class="sd">                - Input parameters (when no positional input is provided)</span>
<span class="sd">                - Control parameters recognized by the agent</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the agent&#39;s execution.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If both positional inputs and non-control keyword arguments are</span>
<span class="sd">                provided simultaneously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_engine</span><span class="p">(</span>
            <span class="n">invoke_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_invoke</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
            <span class="n">raw_debug</span><span class="o">=</span><span class="n">raw_debug</span><span class="p">,</span>
            <span class="n">save_json</span><span class="o">=</span><span class="n">save_json</span><span class="p">,</span>
            <span class="n">save_otel</span><span class="o">=</span><span class="n">save_otel</span><span class="p">,</span>
            <span class="n">metrics_path</span><span class="o">=</span><span class="n">metrics_path</span><span class="p">,</span>
            <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="n">save_raw_snapshot</span><span class="p">,</span>
            <span class="n">save_raw_records</span><span class="o">=</span><span class="n">save_raw_records</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># NOTE: The `ainvoke` method uses the PEP 570 `/,*` notation to explicitly state which</span>
    <span class="c1"># arguments can and cannot be passed as positional or keyword arguments.</span>
    <span class="nd">@final</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ainvoke</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InputLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">raw_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_otel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_records</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Asynchrnously executes the agent with the provided inputs and configuration.</span>

<span class="sd">        (Async version of `invoke`.)</span>

<span class="sd">        This is the main entry point for agent execution. It handles input normalization,</span>
<span class="sd">        telemetry tracking, and proper execution context management. The method supports</span>
<span class="sd">        flexible input formats - either as a positional argument or as keyword arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: Optional positional input to the agent. If provided, all non-control</span>
<span class="sd">                keyword arguments will be rejected to avoid ambiguity.</span>
<span class="sd">            raw_debug: If True, displays raw telemetry data for debugging purposes.</span>
<span class="sd">            save_json: If True, saves telemetry data as JSON.</span>
<span class="sd">            save_otel: If True, saves telemetry data to OpenTelemetry endpoint.</span>
<span class="sd">            metrics_path: Optional file path where telemetry metrics should be saved.</span>
<span class="sd">            save_raw_snapshot: If True, saves a raw snapshot of the telemetry data.</span>
<span class="sd">            save_raw_records: If True, saves raw telemetry records.</span>
<span class="sd">            config: Optional configuration dictionary to override default settings.</span>
<span class="sd">            **kwargs: Additional keyword arguments that can be either:</span>
<span class="sd">                - Input parameters (when no positional input is provided)</span>
<span class="sd">                - Control parameters recognized by the agent</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the agent&#39;s execution.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If both positional inputs and non-control keyword arguments are</span>
<span class="sd">                provided simultaneously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_engine</span><span class="p">(</span>
            <span class="n">invoke_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ainvoke</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
            <span class="n">raw_debug</span><span class="o">=</span><span class="n">raw_debug</span><span class="p">,</span>
            <span class="n">save_json</span><span class="o">=</span><span class="n">save_json</span><span class="p">,</span>
            <span class="n">save_otel</span><span class="o">=</span><span class="n">save_otel</span><span class="p">,</span>
            <span class="n">metrics_path</span><span class="o">=</span><span class="n">metrics_path</span><span class="p">,</span>
            <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="n">save_raw_snapshot</span><span class="p">,</span>
            <span class="n">save_raw_records</span><span class="o">=</span><span class="n">save_raw_records</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">TState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format a plain text prompt into the agent&#39;s input schema</span>
<span class="sd">        possibly incorporating the prior state.</span>

<span class="sd">        Agents should override this method for their operation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">prompt</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">state</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_inputs</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">TState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts a plain text response from the Agent&#39;s output schema</span>

<span class="sd">        Agents should override this method for their operation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">BaseMessage</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">InputLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalizes various input formats into a standardized mapping.</span>

<span class="sd">        This method converts different input types into a consistent dictionary format</span>
<span class="sd">        that can be processed by the agent. String inputs are wrapped as messages, while</span>
<span class="sd">        mappings are passed through unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: The input to normalize. Can be a string (which will be converted to a</span>
<span class="sd">                message) or a mapping (which will be returned as-is).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A mapping containing the normalized inputs, with keys appropriate for agent</span>
<span class="sd">            processing.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input type is not supported (neither string nor mapping).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Adjust to your message type</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">inputs</span><span class="p">)]}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">inputs</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported input type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compiled_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledStateGraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the compiled StateGraph application for the agent.&quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="n">compiled</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">checkpointer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpointer</span><span class="p">,</span>
            <span class="n">store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">({</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_graph</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseStore</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a SQLite-backed LangGraph store for persistent graph data.&quot;&quot;&quot;</span>
        <span class="n">store_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">/</span> <span class="s2">&quot;graph_store.sqlite&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">store_path</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">isolation_level</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">SqliteStore</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook_storage_setup</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">store</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hook_storage_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@final</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateGraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build and return the StateGraph backing this agent.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_type</span><span class="p">,</span>
            <span class="n">context_schema</span><span class="o">=</span><span class="n">AgentContext</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_graph</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the StateGraph for this agent without compiling.</span>

<span class="sd">        Called during `__post_init__()` after the Agent has been fully</span>
<span class="sd">        Initialized (`__post_init__` is called after `__init__`) to</span>
<span class="sd">        instantiate `self.graph`</span>

<span class="sd">        Agents should implement this to define their their behavior.</span>

<span class="sd">        Agents should treat `self.graph` as read-only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_graph</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">graph_app</span><span class="p">:</span> <span class="n">CompiledStateGraph</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledStateGraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook for subclasses to wrap or modify the compiled graph.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">graph_app</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tool_is_async_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True for tools that can only be invoked asynchronously.</span>

<span class="sd">        MCP tools are commonly exposed as StructuredTool instances with a</span>
<span class="sd">        coroutine implementation but no synchronous function implementation.</span>
<span class="sd">        Those raise errors like:</span>

<span class="sd">            &quot;StructuredTool does not support sync invocation.&quot;</span>

<span class="sd">        when called via `.invoke()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">coroutine</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="s2">&quot;coroutine&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coroutine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_has_async_only_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">tools_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tools_obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tool_iter</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">tools_obj</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">tools_obj</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool_is_async_only</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tool_iter</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># If we have async-only tools (e.g. MCP StructuredTools), we must run the</span>
        <span class="c1"># graph via `ainvoke` so ToolNode dispatches tools asynchronously.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_async_only_tools</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span>
                        <span class="nb">input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;This agent has async-only tools, but `.invoke()` was called &quot;</span>
                <span class="s2">&quot;from an async context (a running event loop was detected). &quot;</span>
                <span class="s2">&quot;Use `await agent.ainvoke(...)` instead.&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Fallback: if a tool raises the canonical sync-invoke error, retry</span>
            <span class="c1"># with ainvoke for backwards compatibility.</span>
            <span class="k">if</span> <span class="s2">&quot;does not support sync invocation&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span>
                            <span class="nb">input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ainvoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_graph</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">InputLike</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Specify calling behavior for class instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Runtime enforcement: forbid subclasses from overriding invoke</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure subclass does not override key method.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;invoke&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must not override BaseAgent.invoke(); &quot;</span>
                <span class="s2">&quot;implement _invoke() only.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="c1"># Init graph after subclass has been fully constructed</span>
        <span class="n">orig_init</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">orig_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="fm">__init__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">InputLike</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># allow positional/keyword like LangGraph</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">raw_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_otel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_snapshot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_raw_records</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Streams agent responses with telemetry tracking.</span>

<span class="sd">        This method serves as the public streaming entry point for agent interactions.</span>
<span class="sd">        It wraps the actual streaming implementation with telemetry tracking to capture</span>
<span class="sd">        metrics and debugging information.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: The input to process, which will be normalized internally.</span>
<span class="sd">            config: Optional configuration for the agent, compatible with LangGraph</span>
<span class="sd">                positional/keyword argument style.</span>
<span class="sd">            raw_debug: If True, renders raw debug information in telemetry output.</span>
<span class="sd">            save_json: If True, saves telemetry data as JSON.</span>
<span class="sd">            metrics_path: Optional file path where metrics should be saved.</span>
<span class="sd">            save_raw_snapshot: If True, saves raw snapshot data in telemetry.</span>
<span class="sd">            save_raw_records: If True, saves raw record data in telemetry.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to the streaming</span>
<span class="sd">                implementation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterator yielding the agent&#39;s responses.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method tracks invocation depth to properly handle nested agent calls</span>
<span class="sd">            and ensure telemetry is only rendered once at the top level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Track invocation depth to handle nested agent calls</span>
        <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start telemetry tracking for top-level invocations only</span>
            <span class="k">if</span> <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">begin_run</span><span class="p">(</span>
                    <span class="n">agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span>
                <span class="p">)</span>

            <span class="c1"># Normalize inputs and delegate to the actual streaming implementation</span>
            <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Decrement invocation depth when exiting</span>
            <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="c1"># Render telemetry data only for top-level invocations</span>
            <span class="k">if</span> <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">raw</span><span class="o">=</span><span class="n">raw_debug</span><span class="p">,</span>
                    <span class="n">save_json</span><span class="o">=</span><span class="n">save_json</span><span class="p">,</span>
                    <span class="n">save_otel</span><span class="o">=</span><span class="n">save_otel</span><span class="p">,</span>
                    <span class="n">filepath</span><span class="o">=</span><span class="n">metrics_path</span><span class="p">,</span>
                    <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="n">save_raw_snapshot</span><span class="p">,</span>
                    <span class="n">save_raw_records</span><span class="o">=</span><span class="n">save_raw_records</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_node_tags</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">extra</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate default tags for a graph node.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the node.</span>
<span class="sd">            extra: Optional sequence of additional tags to include.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: A list of tags for the node, including the agent name, &#39;graph&#39;,</span>
<span class="sd">                the node name, and any extra tags provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start with standard tags: agent name, graph indicator, and node name</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span>

        <span class="c1"># Add any extra tags if provided</span>
        <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tags</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_node_cfg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a consistent configuration for a node/runnable.</span>

<span class="sd">        Creates a configuration dict that can be reapplied after operations like</span>
<span class="sd">        .map(), subgraph compile, etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the node.</span>
<span class="sd">            *extra_tags: Additional tags to include in the node configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A configuration dictionary with run_name, tags, and metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the namespace - use first extra tag if available, otherwise</span>
        <span class="c1"># convert agent name to snake_case</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">extra_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">extra_tags</span> <span class="k">else</span> <span class="n">_to_snake</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Combine all tags: agent name, graph indicator, node name, and any extra tags</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">]</span>

        <span class="c1"># Return the complete configuration dictionary</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;node&quot;</span><span class="p">,</span>  <span class="c1"># keep &quot;node:&quot; prefixing in the timer</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;langgraph_node&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;ursa_ns&quot;</span><span class="p">:</span> <span class="n">ns</span><span class="p">,</span>
                <span class="s2">&quot;ursa_agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runnable_or_fn</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a runnable with node configuration applied.</span>

<span class="sd">        Applies the agent&#39;s node configuration to a runnable or callable. This method</span>
<span class="sd">        should be called again after operations like .map() or subgraph .compile() as</span>
<span class="sd">        these operations may drop configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            runnable_or_fn: A runnable or callable to configure.</span>
<span class="sd">            name: The name to assign to this node.</span>
<span class="sd">            *extra_tags: Additional tags to apply to the node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A configured runnable with the agent&#39;s node configuration applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert input to a runnable if it&#39;s not already one</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">coerce_to_runnable</span><span class="p">(</span><span class="n">runnable_or_fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Apply node configuration and return the configured runnable</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_node_cfg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wrap_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn_or_runnable</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap a function or runnable as a node in the graph.</span>

<span class="sd">        This is a convenience wrapper around the ns() method.</span>

<span class="sd">        Args:</span>
<span class="sd">            fn_or_runnable: A function or runnable to wrap as a node.</span>
<span class="sd">            name: The name to assign to this node.</span>
<span class="sd">            *extra_tags: Additional tags to apply to the node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A configured runnable with the agent&#39;s node configuration applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">(</span><span class="n">fn_or_runnable</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wrap_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap a conditional function as a routing node in the graph.</span>

<span class="sd">        Creates a runnable lambda with routing-specific configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            fn: The conditional function to wrap.</span>
<span class="sd">            name: The name of the routing node.</span>
<span class="sd">            *extra_tags: Additional tags to apply to the node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A configured RunnableLambda with routing-specific metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use the first extra tag as namespace, or fall back to agent name in snake_case</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">extra_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">extra_tags</span> <span class="k">else</span> <span class="n">_to_snake</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Create and return a configured RunnableLambda for routing</span>
        <span class="k">return</span> <span class="n">RunnableLambda</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span>
            <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;node&quot;</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;graph&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;route:</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="o">*</span><span class="n">extra_tags</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;langgraph_node&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;route:</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ursa_ns&quot;</span><span class="p">:</span> <span class="n">ns</span><span class="p">,</span>
                <span class="s2">&quot;ursa_agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_named</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runnable</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a specific name and configuration to a runnable.</span>

<span class="sd">        Configures a runnable with a specific name and the agent&#39;s metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            runnable: The runnable to configure.</span>
<span class="sd">            name: The name to assign to this runnable.</span>
<span class="sd">            *extra_tags: Additional tags to apply to the runnable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A configured runnable with the specified name and agent metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use the first extra tag as namespace, or fall back to agent name in snake_case</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">extra_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">extra_tags</span> <span class="k">else</span> <span class="n">_to_snake</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Apply configuration and return the configured runnable</span>
        <span class="k">return</span> <span class="n">runnable</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span>
            <span class="n">run_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">],</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;langgraph_node&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;ursa_ns&quot;</span><span class="p">:</span> <span class="n">ns</span><span class="p">,</span>
                <span class="s2">&quot;ursa_agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="ursa.agents.base.BaseAgent.compiled_graph" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compiled_graph</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Return the compiled StateGraph application for the agent.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="ursa.agents.base.BaseAgent.context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">context</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Immutable run-scoped information provided to the Agent's graph</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="ursa.agents.base.BaseAgent.name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">name</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Agent name.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="ursa.agents.base.BaseAgent.storage" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">storage</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Create a SQLite-backed LangGraph store for persistent graph data.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Specify calling behavior for class instance.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">InputLike</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specify calling behavior for class instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enable_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metrics_dir</span><span class="o">=</span><span class="s1">&#39;ursa_metrics&#39;</span><span class="p">,</span> <span class="n">autosave_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">otel_metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initializes the base agent with a language model and optional configurations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>llm</code>
            </td>
            <td>
                  <code><span title="langchain.chat_models.BaseChatModel">BaseChatModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a BaseChatModel instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>checkpointer</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="langgraph.checkpoint.base.BaseCheckpointSaver">BaseCheckpointSaver</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional checkpoint saver for persisting agent state.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_metrics</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to collect performance and usage metrics.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metrics_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where metrics will be saved.</p>
              </div>
            </td>
            <td>
                  <code>&#39;ursa_metrics&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>autosave_metrics</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to automatically save metrics to disk.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thread_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this agent instance. Generated if not
       provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
    <span class="n">workspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">checkpointer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseCheckpointSaver</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">metrics_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ursa_metrics&quot;</span><span class="p">,</span>  <span class="c1"># dir to save metrics, with a default</span>
    <span class="n">autosave_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">otel_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">thread_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the base agent with a language model and optional configurations.</span>

<span class="sd">    Args:</span>
<span class="sd">        llm: a BaseChatModel instance.</span>
<span class="sd">        checkpointer: Optional checkpoint saver for persisting agent state.</span>
<span class="sd">        enable_metrics: Whether to collect performance and usage metrics.</span>
<span class="sd">        metrics_dir: Directory path where metrics will be saved.</span>
<span class="sd">        autosave_metrics: Whether to automatically save metrics to disk.</span>
<span class="sd">        thread_id: Unique identifier for this agent instance. Generated if not</span>
<span class="sd">                   provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span> <span class="o">=</span> <span class="n">llm</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">workspace</span> <span class="ow">or</span> <span class="s2">&quot;ursa_workspace&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">thread_id</span> <span class="ow">or</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">checkpointer</span> <span class="o">=</span> <span class="n">checkpointer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span> <span class="o">=</span> <span class="n">Telemetry</span><span class="p">(</span>
        <span class="n">enable</span><span class="o">=</span><span class="n">enable_metrics</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">metrics_dir</span><span class="p">),</span>
        <span class="n">save_json_default</span><span class="o">=</span><span class="n">autosave_metrics</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.__init_subclass__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Ensure subclass does not override key method.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure subclass does not override key method.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;invoke&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must not override BaseAgent.invoke(); &quot;</span>
            <span class="s2">&quot;implement _invoke() only.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="c1"># Init graph after subclass has been fully constructed</span>
    <span class="n">orig_init</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">orig_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

    <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="fm">__init__</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.add_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_node</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agent_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add a node to the state graph with token usage tracking.</p>
<p>This method adds a function as a node to the state graph, wrapping it to track
token usage during execution. The node is identified by either the provided
node_name or the function's name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>f</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[..., <span title="typing.Mapping">Mapping</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to add as a node. Should return a mapping of string keys to
any values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>node_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the node. If not provided, the function's name
will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>agent_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional agent name for tracking. If not provided, the agent's
name in snake_case will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="langgraph.graph.state.StateGraph">StateGraph</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated StateGraph with the new node added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_node</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">node_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">agent_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateGraph</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a node to the state graph with token usage tracking.</span>

<span class="sd">    This method adds a function as a node to the state graph, wrapping it to track</span>
<span class="sd">    token usage during execution. The node is identified by either the provided</span>
<span class="sd">    node_name or the function&#39;s name.</span>

<span class="sd">    Args:</span>
<span class="sd">        f: The function to add as a node. Should return a mapping of string keys to</span>
<span class="sd">            any values.</span>
<span class="sd">        node_name: Optional name for the node. If not provided, the function&#39;s name</span>
<span class="sd">            will be used.</span>
<span class="sd">        agent_name: Optional agent name for tracking. If not provided, the agent&#39;s</span>
<span class="sd">            name in snake_case will be used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated StateGraph with the new node added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_node_name</span> <span class="o">=</span> <span class="n">node_name</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">_agent_name</span> <span class="o">=</span> <span class="n">agent_name</span> <span class="ow">or</span> <span class="n">_to_snake</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">wrapped_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_node</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_node_name</span><span class="p">,</span> <span class="n">_agent_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">_node_name</span><span class="p">,</span> <span class="n">wrapped_node</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.ainvoke" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ainvoke</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">raw_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_json</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_otel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_raw_records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Asynchrnously executes the agent with the provided inputs and configuration.</p>
<p>(Async version of <code>invoke</code>.)</p>
<p>This is the main entry point for agent execution. It handles input normalization,
telemetry tracking, and proper execution context management. The method supports
flexible input formats - either as a positional argument or as keyword arguments.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="ursa.agents.base.InputLike">InputLike</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional positional input to the agent. If provided, all non-control
keyword arguments will be rejected to avoid ambiguity.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>raw_debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, displays raw telemetry data for debugging purposes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_json</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves telemetry data as JSON.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_otel</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves telemetry data to OpenTelemetry endpoint.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metrics_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional file path where telemetry metrics should be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_raw_snapshot</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves a raw snapshot of the telemetry data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_raw_records</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves raw telemetry records.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional configuration dictionary to override default settings.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that can be either:
- Input parameters (when no positional input is provided)
- Control parameters recognized by the agent</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The result of the agent's execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If both positional inputs and non-control keyword arguments are
provided simultaneously.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@final</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ainvoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InputLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">raw_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_otel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metrics_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_raw_snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_raw_records</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asynchrnously executes the agent with the provided inputs and configuration.</span>

<span class="sd">    (Async version of `invoke`.)</span>

<span class="sd">    This is the main entry point for agent execution. It handles input normalization,</span>
<span class="sd">    telemetry tracking, and proper execution context management. The method supports</span>
<span class="sd">    flexible input formats - either as a positional argument or as keyword arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        inputs: Optional positional input to the agent. If provided, all non-control</span>
<span class="sd">            keyword arguments will be rejected to avoid ambiguity.</span>
<span class="sd">        raw_debug: If True, displays raw telemetry data for debugging purposes.</span>
<span class="sd">        save_json: If True, saves telemetry data as JSON.</span>
<span class="sd">        save_otel: If True, saves telemetry data to OpenTelemetry endpoint.</span>
<span class="sd">        metrics_path: Optional file path where telemetry metrics should be saved.</span>
<span class="sd">        save_raw_snapshot: If True, saves a raw snapshot of the telemetry data.</span>
<span class="sd">        save_raw_records: If True, saves raw telemetry records.</span>
<span class="sd">        config: Optional configuration dictionary to override default settings.</span>
<span class="sd">        **kwargs: Additional keyword arguments that can be either:</span>
<span class="sd">            - Input parameters (when no positional input is provided)</span>
<span class="sd">            - Control parameters recognized by the agent</span>

<span class="sd">    Returns:</span>
<span class="sd">        The result of the agent&#39;s execution.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If both positional inputs and non-control keyword arguments are</span>
<span class="sd">            provided simultaneously.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_engine</span><span class="p">(</span>
        <span class="n">invoke_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ainvoke</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
        <span class="n">raw_debug</span><span class="o">=</span><span class="n">raw_debug</span><span class="p">,</span>
        <span class="n">save_json</span><span class="o">=</span><span class="n">save_json</span><span class="p">,</span>
        <span class="n">save_otel</span><span class="o">=</span><span class="n">save_otel</span><span class="p">,</span>
        <span class="n">metrics_path</span><span class="o">=</span><span class="n">metrics_path</span><span class="p">,</span>
        <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="n">save_raw_snapshot</span><span class="p">,</span>
        <span class="n">save_raw_records</span><span class="o">=</span><span class="n">save_raw_records</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.build_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_config</span><span class="p">(</span><span class="o">**</span><span class="n">overrides</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Constructs a config dictionary for agent operations with telemetry support.</p>
<p>This method creates a standardized configuration dictionary that includes thread
identification, telemetry callbacks, and other metadata needed for agent
operations. The configuration can be customized through override parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>**overrides</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional configuration overrides that can include keys like
'recursion_limit', 'configurable', 'metadata', 'tags', etc.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A complete configuration dictionary with all necessary parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructs a config dictionary for agent operations with telemetry support.</span>

<span class="sd">    This method creates a standardized configuration dictionary that includes thread</span>
<span class="sd">    identification, telemetry callbacks, and other metadata needed for agent</span>
<span class="sd">    operations. The configuration can be customized through override parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        **overrides: Optional configuration overrides that can include keys like</span>
<span class="sd">            &#39;recursion_limit&#39;, &#39;configurable&#39;, &#39;metadata&#39;, &#39;tags&#39;, etc.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A complete configuration dictionary with all necessary parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the base configuration with essential fields.</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span><span class="p">},</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span><span class="p">,</span>
            <span class="s2">&quot;telemetry_run_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
        <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Try to determine the model name from either direct or nested attributes</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;llm_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;llm&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># Add model name to metadata if available</span>
    <span class="k">if</span> <span class="n">model_name</span><span class="p">:</span>
        <span class="n">base</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_name</span>

    <span class="c1"># Handle configurable dictionary overrides by merging with base configurable</span>
    <span class="k">if</span> <span class="s2">&quot;configurable&quot;</span> <span class="ow">in</span> <span class="n">overrides</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">],</span> <span class="nb">dict</span>
    <span class="p">):</span>
        <span class="n">base</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;configurable&quot;</span><span class="p">))</span>

    <span class="c1"># Handle metadata dictionary overrides by merging with base metadata</span>
    <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">overrides</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">base</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">))</span>

    <span class="c1"># Merge tags from caller-provided overrides, avoid duplicates</span>
    <span class="k">if</span> <span class="s2">&quot;tags&quot;</span> <span class="ow">in</span> <span class="n">overrides</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">base</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">overrides</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="c1"># Apply any remaining overrides directly to the base configuration</span>
    <span class="n">base</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">base</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.build_graph" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_graph</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Build and return the StateGraph backing this agent.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@final</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateGraph</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build and return the StateGraph backing this agent.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_type</span><span class="p">,</span>
        <span class="n">context_schema</span><span class="o">=</span><span class="n">AgentContext</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_build_graph</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.format_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">format_query</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Format a plain text prompt into the agent's input schema
possibly incorporating the prior state.</p>
<p>Agents should override this method for their operation</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">format_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">TState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format a plain text prompt into the agent&#39;s input schema</span>
<span class="sd">    possibly incorporating the prior state.</span>

<span class="sd">    Agents should override this method for their operation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">prompt</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">state</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_inputs</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.format_result" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">format_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Extracts a plain text response from the Agent's output schema</p>
<p>Agents should override this method for their operation</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">TState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts a plain text response from the Agent&#39;s output schema</span>

<span class="sd">    Agents should override this method for their operation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">BaseMessage</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.invoke" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invoke</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">raw_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_json</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_otel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_raw_records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Executes the agent with the provided inputs and configuration.</p>
<p>This is the main entry point for agent execution. It handles input normalization,
telemetry tracking, and proper execution context management. The method supports
flexible input formats - either as a positional argument or as keyword arguments.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="ursa.agents.base.InputLike">InputLike</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional positional input to the agent. If provided, all non-control
keyword arguments will be rejected to avoid ambiguity.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>raw_debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, displays raw telemetry data for debugging purposes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_json</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves telemetry data as JSON.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_otel</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves telemetry data to OpenTelemetry endpoint.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metrics_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional file path where telemetry metrics should be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_raw_snapshot</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves a raw snapshot of the telemetry data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_raw_records</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves raw telemetry records.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional configuration dictionary to override default settings.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that can be either:
- Input parameters (when no positional input is provided)
- Control parameters recognized by the agent</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The result of the agent's execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If both positional inputs and non-control keyword arguments are
provided simultaneously.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@final</span>
<span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InputLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">raw_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_otel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metrics_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_raw_snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_raw_records</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Executes the agent with the provided inputs and configuration.</span>

<span class="sd">    This is the main entry point for agent execution. It handles input normalization,</span>
<span class="sd">    telemetry tracking, and proper execution context management. The method supports</span>
<span class="sd">    flexible input formats - either as a positional argument or as keyword arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        inputs: Optional positional input to the agent. If provided, all non-control</span>
<span class="sd">            keyword arguments will be rejected to avoid ambiguity.</span>
<span class="sd">        raw_debug: If True, displays raw telemetry data for debugging purposes.</span>
<span class="sd">        save_json: If True, saves telemetry data as JSON.</span>
<span class="sd">        save_otel: If True, saves telemetry data to OpenTelemetry endpoint.</span>
<span class="sd">        metrics_path: Optional file path where telemetry metrics should be saved.</span>
<span class="sd">        save_raw_snapshot: If True, saves a raw snapshot of the telemetry data.</span>
<span class="sd">        save_raw_records: If True, saves raw telemetry records.</span>
<span class="sd">        config: Optional configuration dictionary to override default settings.</span>
<span class="sd">        **kwargs: Additional keyword arguments that can be either:</span>
<span class="sd">            - Input parameters (when no positional input is provided)</span>
<span class="sd">            - Control parameters recognized by the agent</span>

<span class="sd">    Returns:</span>
<span class="sd">        The result of the agent&#39;s execution.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If both positional inputs and non-control keyword arguments are</span>
<span class="sd">            provided simultaneously.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_engine</span><span class="p">(</span>
        <span class="n">invoke_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_invoke</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
        <span class="n">raw_debug</span><span class="o">=</span><span class="n">raw_debug</span><span class="p">,</span>
        <span class="n">save_json</span><span class="o">=</span><span class="n">save_json</span><span class="p">,</span>
        <span class="n">save_otel</span><span class="o">=</span><span class="n">save_otel</span><span class="p">,</span>
        <span class="n">metrics_path</span><span class="o">=</span><span class="n">metrics_path</span><span class="p">,</span>
        <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="n">save_raw_snapshot</span><span class="p">,</span>
        <span class="n">save_raw_records</span><span class="o">=</span><span class="n">save_raw_records</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.ns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ns</span><span class="p">(</span><span class="n">runnable_or_fn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Return a runnable with node configuration applied.</p>
<p>Applies the agent's node configuration to a runnable or callable. This method
should be called again after operations like .map() or subgraph .compile() as
these operations may drop configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>runnable_or_fn</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A runnable or callable to configure.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name to assign to this node.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>*extra_tags</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional tags to apply to the node.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A configured runnable with the agent's node configuration applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runnable_or_fn</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a runnable with node configuration applied.</span>

<span class="sd">    Applies the agent&#39;s node configuration to a runnable or callable. This method</span>
<span class="sd">    should be called again after operations like .map() or subgraph .compile() as</span>
<span class="sd">    these operations may drop configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        runnable_or_fn: A runnable or callable to configure.</span>
<span class="sd">        name: The name to assign to this node.</span>
<span class="sd">        *extra_tags: Additional tags to apply to the node.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A configured runnable with the agent&#39;s node configuration applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert input to a runnable if it&#39;s not already one</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">coerce_to_runnable</span><span class="p">(</span><span class="n">runnable_or_fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Apply node configuration and return the configured runnable</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">with_config</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_node_cfg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tags</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.stream" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stream</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">raw_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_json</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_otel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_raw_records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Streams agent responses with telemetry tracking.</p>
<p>This method serves as the public streaming entry point for agent interactions.
It wraps the actual streaming implementation with telemetry tracking to capture
metrics and debugging information.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="ursa.agents.base.InputLike">InputLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input to process, which will be normalized internally.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional configuration for the agent, compatible with LangGraph
positional/keyword argument style.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>raw_debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, renders raw debug information in telemetry output.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_json</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves telemetry data as JSON.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metrics_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional file path where metrics should be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_raw_snapshot</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves raw snapshot data in telemetry.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_raw_records</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves raw record data in telemetry.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to the streaming
implementation.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Iterator">Iterator</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An iterator yielding the agent's responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This method tracks invocation depth to properly handle nested agent calls
and ensure telemetry is only rendered once at the top level.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">InputLike</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># allow positional/keyword like LangGraph</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">raw_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_otel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metrics_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_raw_snapshot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_raw_records</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Streams agent responses with telemetry tracking.</span>

<span class="sd">    This method serves as the public streaming entry point for agent interactions.</span>
<span class="sd">    It wraps the actual streaming implementation with telemetry tracking to capture</span>
<span class="sd">    metrics and debugging information.</span>

<span class="sd">    Args:</span>
<span class="sd">        inputs: The input to process, which will be normalized internally.</span>
<span class="sd">        config: Optional configuration for the agent, compatible with LangGraph</span>
<span class="sd">            positional/keyword argument style.</span>
<span class="sd">        raw_debug: If True, renders raw debug information in telemetry output.</span>
<span class="sd">        save_json: If True, saves telemetry data as JSON.</span>
<span class="sd">        metrics_path: Optional file path where metrics should be saved.</span>
<span class="sd">        save_raw_snapshot: If True, saves raw snapshot data in telemetry.</span>
<span class="sd">        save_raw_records: If True, saves raw record data in telemetry.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to the streaming</span>
<span class="sd">            implementation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An iterator yielding the agent&#39;s responses.</span>

<span class="sd">    Note:</span>
<span class="sd">        This method tracks invocation depth to properly handle nested agent calls</span>
<span class="sd">        and ensure telemetry is only rendered once at the top level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Track invocation depth to handle nested agent calls</span>
    <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start telemetry tracking for top-level invocations only</span>
        <span class="k">if</span> <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">begin_run</span><span class="p">(</span>
                <span class="n">agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span>
            <span class="p">)</span>

        <span class="c1"># Normalize inputs and delegate to the actual streaming implementation</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Decrement invocation depth when exiting</span>
        <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Render telemetry data only for top-level invocations</span>
        <span class="k">if</span> <span class="n">BaseAgent</span><span class="o">.</span><span class="n">_invoke_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">telemetry</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw_debug</span><span class="p">,</span>
                <span class="n">save_json</span><span class="o">=</span><span class="n">save_json</span><span class="p">,</span>
                <span class="n">save_otel</span><span class="o">=</span><span class="n">save_otel</span><span class="p">,</span>
                <span class="n">filepath</span><span class="o">=</span><span class="n">metrics_path</span><span class="p">,</span>
                <span class="n">save_raw_snapshot</span><span class="o">=</span><span class="n">save_raw_snapshot</span><span class="p">,</span>
                <span class="n">save_raw_records</span><span class="o">=</span><span class="n">save_raw_records</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.base.BaseAgent.write_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_state</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Writes agent state to a JSON file.</p>
<p>Serializes the provided state dictionary to JSON format and writes it to the
specified file. The JSON is written with non-ASCII characters preserved.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the file where state will be written.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the agent state to be serialized.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes agent state to a JSON file.</span>

<span class="sd">    Serializes the provided state dictionary to JSON format and writes it to the</span>
<span class="sd">    specified file. The JSON is written with non-ASCII characters preserved.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Path to the file where state will be written.</span>
<span class="sd">        state: Dictionary containing the agent state to be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">json_state</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_state</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.chat_agent" class="doc doc-heading">
            <code>chat_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.chat_agent.ChatAgent" class="doc doc-heading">
            <code>ChatAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a>[<span title="ursa.agents.chat_agent.ChatState">ChatState</span>]</code></p>


        <p>Chat Agent</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/chat_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ChatAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">[</span><span class="n">ChatState</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Chat Agent&quot;&quot;&quot;</span>

    <span class="n">state_type</span> <span class="o">=</span> <span class="n">ChatState</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_response_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatState</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">res</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ChatState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">ChatState</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">get_chatter_system_prompt</span><span class="p">())]</span>
            <span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">prompt</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">ChatState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;_response_node&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;_response_node&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.code_review_agent" class="doc doc-heading">
            <code>code_review_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ursa.agents.code_review_agent.read_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Reads in a file with a given filename into a string</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>string filename to read in</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/code_review_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">InjectedState</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in a file with a given filename into a string</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: string filename to read in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workspace_dir</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">]</span>
    <span class="n">full_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[READING]: &quot;</span><span class="p">,</span> <span class="n">full_filename</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file_contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">file_contents</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ursa.agents.code_review_agent.run_cmd" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_cmd</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run command from commandline</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/code_review_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_cmd</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">InjectedState</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run command from commandline&quot;&quot;&quot;</span>
    <span class="n">workspace_dir</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RUNNING: &quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">workspace_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STDOUT: &quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STDERR: &quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;STDOUT: </span><span class="si">{</span><span class="n">stdout</span><span class="si">}</span><span class="s2"> and STDERR: </span><span class="si">{</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ursa.agents.code_review_agent.write_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_file</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Writes text to a file in the given workspace as requested.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>code</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text to write to a file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the filename to write to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Execution results</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/code_review_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">write_file</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">InjectedState</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes text to a file in the given workspace as requested.</span>

<span class="sd">    Args:</span>
<span class="sd">        code: Text to write to a file</span>
<span class="sd">        filename: the filename to write to</span>

<span class="sd">    Returns:</span>
<span class="sd">        Execution results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workspace_dir</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[WRITING]: &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract code if wrapped in markdown code blocks</span>
        <span class="k">if</span> <span class="s2">&quot;```&quot;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">code_parts</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Extract the actual code</span>
                <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">code_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">code_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Write code to a file</span>
        <span class="n">code_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">code_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Written code to file: </span><span class="si">{</span><span class="n">code_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> written successfully.&quot;</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating code: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Return minimal code that prints the error</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Failed to write </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> successfully.&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.execution_agent" class="doc doc-heading">
            <code>execution_agent</code>


</h2>

    <div class="doc doc-contents ">

        <p>Execution agent that builds a tool-enabled state graph to autonomously run tasks.</p>
<p>This module implements ExecutionAgent, a LangGraph-based agent that executes user
instructions by invoking LLM tool calls and coordinating a controlled workflow.</p>
<p>Key features:
- Workspace management with optional symlinking for external sources.
- Safety-checked shell execution via run_command with output size budgeting.
- Code authoring and edits through write_code and edit_code with rich previews.
- Web search capability through DuckDuckGoSearchResults.
- Summarization of the session and optional memory logging.
- Configurable graph with nodes for agent, action, and summarize.</p>
<p>Implementation notes:
- LLM prompts are sourced from prompt_library.execution_prompts.
- Outputs from subprocess are trimmed under MAX_TOOL_MSG_CHARS to fit tool messages.
- The agent uses ToolNode and LangGraph StateGraph to loop until no tool calls remain.
- Safety gates block unsafe shell commands and surface the rationale to the user.</p>
<p>Environment:
- MAX_TOOL_MSG_CHARS caps combined stdout/stderr in tool responses.</p>
<p>Entry points:
- ExecutionAgent._invoke(...) runs the compiled graph.
- main() shows a minimal demo that writes and runs a script.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.execution_agent.ExecutionAgent" class="doc doc-heading">
            <code>ExecutionAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AgentWithTools (ursa.agents.base.AgentWithTools)" href="#ursa.agents.base.AgentWithTools">AgentWithTools</a></code>, <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a>[<a class="autorefs autorefs-internal" title="ExecutionState (ursa.agents.execution_agent.ExecutionState)" href="#ursa.agents.execution_agent.ExecutionState">ExecutionState</a>]</code></p>


        <p>Orchestrates model-driven code execution, tool calls, and state management.</p>
<p>Orchestrates model-driven code execution, tool calls, and state management for
iterative program synthesis and shell interaction.</p>
<p>This agent wraps an LLM with a small execution graph that alternates
between issuing model queries, invoking tools (read, run, write, edit, search),
performing safety checks, and summarizing progress. It manages a
workspace on disk, optional symlinks, and an optional memory backend to
persist summaries.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>llm</code>
            </td>
            <td>
                  <code><span title="langchain.chat_models.BaseChatModel">BaseChatModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model identifier or bound chat model
instance. If a string is provided, the BaseAgent initializer will
resolve it.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>agent_memory</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | <a class="autorefs autorefs-internal" title="AgentMemory (ursa.util.memory_logger.AgentMemory)" href="../util/#ursa.util.memory_logger.AgentMemory">AgentMemory</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Memory backend used to
store summarized agent interactions. If provided, summaries are
saved here.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log_state</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When True, the agent writes intermediate json state
to disk for debugging and auditability.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Passed through to the BaseAgent constructor (e.g., model
configuration, checkpointer).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="ursa.agents.execution_agent.ExecutionAgent.safe_codes">safe_codes</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of trusted programming languages for the
agent. Defaults to python and julia</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ursa.agents.execution_agent.ExecutionAgent.executor_prompt">executor_prompt</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt used when invoking the executor LLM
loop.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ursa.agents.execution_agent.ExecutionAgent.recap_prompt">recap_prompt</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt used to request concise summaries for
memory or final output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ursa.agents.execution_agent.ExecutionAgent.tools">tools</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="Tool">Tool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tools available to the agent (run_command, write_code,
edit_code, read_file, run_web_search, run_osti_search, run_arxiv_search),
keyed by tool name for quick lookups.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ursa.agents.execution_agent.ExecutionAgent.tool_node">tool_node</span></code></td>
            <td>
                  <code><span title="ToolNode">ToolNode</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Graph node that dispatches tool calls.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ursa.agents.execution_agent.ExecutionAgent.llm">llm</span></code></td>
            <td>
                  <code><span title="langchain.chat_models.BaseChatModel">BaseChatModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>LLM instance bound to the available tools.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="query_executor(state, runtime) (ursa.agents.execution_agent.ExecutionAgent.query_executor)" href="#ursa.agents.execution_agent.ExecutionAgent.query_executor">query_executor</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Send messages to the executor LLM, ensure
workspace exists, and handle symlink setup before returning the
model response.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="recap(state) (ursa.agents.execution_agent.ExecutionAgent.recap)" href="#ursa.agents.execution_agent.ExecutionAgent.recap">recap</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Produce and optionally persist a summary of recent
interactions to the memory backend.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="ursa.agents.execution_agent.ExecutionAgent._build_graph">_build_graph</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Construct and compile the StateGraph for the agent
loop.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AttributeError">AttributeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accessing the .action attribute raises to encourage
using .stream(...) or .invoke(...).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/execution_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ExecutionAgent</span><span class="p">(</span><span class="n">AgentWithTools</span><span class="p">,</span> <span class="n">BaseAgent</span><span class="p">[</span><span class="n">ExecutionState</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Orchestrates model-driven code execution, tool calls, and state management.</span>

<span class="sd">    Orchestrates model-driven code execution, tool calls, and state management for</span>
<span class="sd">    iterative program synthesis and shell interaction.</span>

<span class="sd">    This agent wraps an LLM with a small execution graph that alternates</span>
<span class="sd">    between issuing model queries, invoking tools (read, run, write, edit, search),</span>
<span class="sd">    performing safety checks, and summarizing progress. It manages a</span>
<span class="sd">    workspace on disk, optional symlinks, and an optional memory backend to</span>
<span class="sd">    persist summaries.</span>

<span class="sd">    Args:</span>
<span class="sd">        llm (BaseChatModel): Model identifier or bound chat model</span>
<span class="sd">            instance. If a string is provided, the BaseAgent initializer will</span>
<span class="sd">            resolve it.</span>
<span class="sd">        agent_memory (Any | AgentMemory, optional): Memory backend used to</span>
<span class="sd">            store summarized agent interactions. If provided, summaries are</span>
<span class="sd">            saved here.</span>
<span class="sd">        log_state (bool): When True, the agent writes intermediate json state</span>
<span class="sd">            to disk for debugging and auditability.</span>
<span class="sd">        **kwargs: Passed through to the BaseAgent constructor (e.g., model</span>
<span class="sd">            configuration, checkpointer).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        safe_codes (list[str]): List of trusted programming languages for the</span>
<span class="sd">            agent. Defaults to python and julia</span>
<span class="sd">        executor_prompt (str): Prompt used when invoking the executor LLM</span>
<span class="sd">            loop.</span>
<span class="sd">        recap_prompt (str): Prompt used to request concise summaries for</span>
<span class="sd">            memory or final output.</span>
<span class="sd">        tools (dict[str, Tool]): Tools available to the agent (run_command, write_code,</span>
<span class="sd">            edit_code, read_file, run_web_search, run_osti_search, run_arxiv_search),</span>
<span class="sd">            keyed by tool name for quick lookups.</span>
<span class="sd">        tool_node (ToolNode): Graph node that dispatches tool calls.</span>
<span class="sd">        llm (BaseChatModel): LLM instance bound to the available tools.</span>

<span class="sd">    Methods:</span>
<span class="sd">        query_executor(state): Send messages to the executor LLM, ensure</span>
<span class="sd">            workspace exists, and handle symlink setup before returning the</span>
<span class="sd">            model response.</span>
<span class="sd">        recap(state): Produce and optionally persist a summary of recent</span>
<span class="sd">            interactions to the memory backend.</span>
<span class="sd">        _build_graph(): Construct and compile the StateGraph for the agent</span>
<span class="sd">            loop.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AttributeError: Accessing the .action attribute raises to encourage</span>
<span class="sd">            using .stream(...) or .invoke(...).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state_type</span> <span class="o">=</span> <span class="n">ExecutionState</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="n">agent_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span> <span class="o">|</span> <span class="n">AgentMemory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">extra_tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tokens_before_summarize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
        <span class="n">messages_to_keep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">safe_codes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">default_tools</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">run_command</span><span class="p">,</span>
            <span class="n">write_code</span><span class="p">,</span>
            <span class="n">edit_code</span><span class="p">,</span>
            <span class="n">read_file</span><span class="p">,</span>
            <span class="n">run_web_search</span><span class="p">,</span>
            <span class="n">run_osti_search</span><span class="p">,</span>
            <span class="n">run_arxiv_search</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">extra_tools</span><span class="p">:</span>
            <span class="n">default_tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_tools</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">default_tools</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_memory</span> <span class="o">=</span> <span class="n">agent_memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">safe_codes</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;julia&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor_prompt</span> <span class="o">=</span> <span class="n">executor_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recap_prompt</span> <span class="o">=</span> <span class="n">recap_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_tools</span> <span class="o">=</span> <span class="n">extra_tools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_state</span> <span class="o">=</span> <span class="n">log_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens_before_summarize</span> <span class="o">=</span> <span class="n">tokens_before_summarize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">messages_to_keep</span> <span class="o">=</span> <span class="n">messages_to_keep</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_patch_dangling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">,</span> <span class="n">summarized</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecutionState</span><span class="p">:</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">dangling_response</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Response Not Found from tool. &quot;</span>
            <span class="s2">&quot;May have timed out or been forgotten due to summarization.&quot;</span>
        <span class="p">)</span>

        <span class="n">tool_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">count_tokens_approximately</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100000</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span> <span class="n">ToolMessage</span>
            <span class="p">):</span>
                <span class="n">trunc_message</span> <span class="o">=</span> <span class="s2">&quot;Message too long - truncated.&quot;</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">trunc_message</span>
                <span class="n">summarized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">tool_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ToolMessage</span><span class="p">):</span>
                <span class="n">tool_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tool_ids</span><span class="p">:</span>
            <span class="n">summarized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[Dangling Tool Call Warning] The following tool IDs &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;were dangling:</span><span class="se">\n</span><span class="si">{</span><span class="n">tool_ids</span><span class="si">}</span><span class="se">\n</span><span class="s2">Replies of missing response applied.&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">tool_id</span> <span class="ow">in</span> <span class="n">tool_ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">msg_ind</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">tc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tool_id</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">]):</span>
                            <span class="c1"># Inserts tool response one after the dangling tool call</span>
                            <span class="c1">#    Mutates new_state so break afterward to reset loop.</span>
                            <span class="c1">#    Not as efficient as could be but should be correct</span>
                            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                                <span class="n">msg_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">ToolMessage</span><span class="p">(</span>
                                    <span class="n">content</span><span class="o">=</span><span class="n">dangling_response</span><span class="p">,</span>
                                    <span class="n">tool_call_id</span><span class="o">=</span><span class="n">tool_id</span><span class="p">,</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">break</span>
        <span class="k">return</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">summarized</span>

    <span class="c1"># Check message history length and summarize to shorten the token usage:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecutionState</span><span class="p">:</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">summarized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tokens_before_summarize</span> <span class="o">=</span> <span class="n">count_tokens_approximately</span><span class="p">(</span>
            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">tokens_before_summarize</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens_before_summarize</span><span class="p">:</span>
            <span class="c1"># Start from 1 to skip system message.</span>
            <span class="n">conversation_to_summarize</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">messages_to_keep</span>
            <span class="p">]</span>
            <span class="n">conversation_to_keep</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">messages_to_keep</span> <span class="p">:</span>
            <span class="p">]</span>
            <span class="n">tool_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">conversation_to_summarize</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                        <span class="n">tool_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ToolMessage</span><span class="p">):</span>
                    <span class="n">tool_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tool_ids</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[Summarizing] The following tool IDs would be cut off:</span><span class="se">\n</span><span class="si">{</span><span class="n">tool_ids</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">conversation_to_keep_copy</span> <span class="o">=</span> <span class="n">conversation_to_keep</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">conversation_to_keep_copy</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ToolMessage</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span> <span class="ow">in</span> <span class="n">tool_ids</span>
                    <span class="p">):</span>
                        <span class="n">conversation_to_summarize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">conversation_to_keep</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">tool_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tool_ids</span><span class="p">:</span>
                <span class="c1"># We may need to implement something here for if a tool has not</span>
                <span class="c1"># responded but its tool call is far enough back that it is being</span>
                <span class="c1"># summarized away. Likely an edge case for non-async, but async</span>
                <span class="c1"># may cause a problem here.</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tool ID &#39;</span><span class="si">{</span><span class="n">tool_ids</span><span class="si">}</span><span class="s2">&#39; was in the messages to summarize, but was not found in the responses. Could be dangling tool call.&quot;</span>
                <span class="p">)</span>
                <span class="k">pass</span>

            <span class="n">summarize_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Your only tasks is to provide a detailed, comprehensive summary of the following</span>
<span class="s2">            conversation.</span>

<span class="s2">            Your summary will be the only information retained from the conversation, so ensure</span>
<span class="s2">            it contains all details that need to be remembered to meet the goals of the work.</span>

<span class="s2">            Conversation to summarize:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">conversation_to_summarize</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">summarize_prompt</span><span class="p">)</span>
            <span class="n">summarized_messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor_prompt</span><span class="p">),</span>
                <span class="n">summary</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">summarized_messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">conversation_to_keep</span><span class="p">)</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Keeping this here for future capability add</span>
            <span class="c1">#    removing this from printing generally,</span>
            <span class="c1">#    but we may want to bring this back with some</span>
            <span class="c1">#    verbosity option in the future.</span>
            <span class="c1">#</span>
            <span class="c1"># Right now setting verbose to False so this is</span>
            <span class="c1">#     always skipped but here to revisit.</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">tokens_after_summarize</span> <span class="o">=</span> <span class="n">count_tokens_approximately</span><span class="p">(</span>
                    <span class="n">summarized_messages</span>
                <span class="p">)</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="n">Panel</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Summarized Conversation History:</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Approximate tokens before: </span><span class="si">{</span><span class="n">tokens_before_summarize</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Approximate tokens after: </span><span class="si">{</span><span class="n">tokens_after_summarize</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">),</span>
                        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;[bold yellow1 on black]Summarize Past Context&quot;</span><span class="p">,</span>
                        <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;yellow1&quot;</span><span class="p">,</span>
                        <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold yellow1 on black&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summarized_messages</span>
            <span class="n">summarized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">summarized</span>

    <span class="c1"># Define the function that calls the model</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_executor</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">,</span> <span class="n">runtime</span><span class="p">:</span> <span class="n">Runtime</span><span class="p">[</span><span class="n">AgentContext</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecutionState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare workspace, handle optional symlinks, and invoke the executor LLM.</span>

<span class="sd">        This method copies the incoming state, ensures a workspace directory exists</span>
<span class="sd">        (creating one with a default name when absent), optionally creates a symlink</span>
<span class="sd">        described by state[&quot;symlinkdir&quot;], sets or injects the executor system prompt</span>
<span class="sd">        as the first message, and invokes the bound LLM. When logging is enabled,</span>
<span class="sd">        it persists the pre-invocation state to disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            state: The current execution state. Expected keys include:</span>
<span class="sd">                - &quot;messages&quot;: Ordered list of System/Human/AI/Tool messages.</span>
<span class="sd">                - &quot;workspace&quot;: Optional path to the working directory.</span>
<span class="sd">                - &quot;symlinkdir&quot;: Optional dict with &quot;source&quot; and &quot;dest&quot; keys.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ExecutionState: Partial state update containing:</span>
<span class="sd">                - &quot;messages&quot;: A list with the model&#39;s response as the latest entry.</span>
<span class="sd">                - &quot;workspace&quot;: The resolved workspace path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add model to the state so it can be passed to tools like the URSA Arxiv or OSTI tools</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">new_state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">full_overwrite</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># 1.5) Check message history length and summarize to shorten the token usage:</span>
        <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_context</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>

        <span class="c1"># 2) Optionally create a symlink if symlinkdir is provided and not yet linked.</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">new_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sd</span> <span class="ow">and</span> <span class="s2">&quot;is_linked&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">:</span>
            <span class="c1"># symlinkdir structure: {&quot;source&quot;: &quot;/path/to/src&quot;, &quot;dest&quot;: &quot;link/name&quot;}</span>
            <span class="n">symlinkdir</span> <span class="o">=</span> <span class="n">sd</span>

            <span class="n">src</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">symlinkdir</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">symlinkdir</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">])</span>

            <span class="c1"># If a file/link already exists at the destination, replace it.</span>
            <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">dst</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="c1"># Ensure parent directories for the link exist.</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Create the symlink (tell pathlib if the target is a directory).</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s2">Symlinked:</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2"> (source) --&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2"> (dest)&quot;</span><span class="p">)</span>
            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">][</span><span class="s2">&quot;is_linked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">full_overwrite</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patch_dangling</span><span class="p">(</span>
            <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span>
        <span class="p">)</span>

        <span class="c1"># 3) Ensure the executor prompt is the first SystemMessage.</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SystemMessage</span><span class="p">):</span>
            <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor_prompt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor_prompt</span><span class="p">)]</span> <span class="o">+</span> <span class="n">messages</span>

        <span class="c1"># 4) Invoke the LLM with the prepared message sequence.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Response error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c1"># 5) Optionally persist the pre-invocation state for audit/debugging.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span><span class="s2">&quot;execution_agent.json&quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full_overwrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">Overwrite</span><span class="p">(</span><span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;symlinkdir&quot;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="s2">&quot;symlinkdir&quot;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">recap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecutionState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a concise summary of the conversation and optionally persist memory.</span>

<span class="sd">        This method builds a summarization prompt, invokes the LLM to obtain a compact</span>
<span class="sd">        summary of recent interactions, optionally logs salient details to the agent</span>
<span class="sd">        memory backend, and writes debug state when logging is enabled.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (ExecutionState): The execution state containing message history.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ExecutionState: A partial update with a single string message containing</span>
<span class="sd">                the recap.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">full_overwrite</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># 0) Check message history length and summarize to shorten the token usage:</span>
        <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_context</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>

        <span class="c1"># 1) Construct the summarization message list (system prompt + prior messages).</span>
        <span class="n">recap_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recap_prompt</span><span class="p">)</span>
        <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">recap_message</span><span class="p">]</span>

        <span class="c1"># 2) Invoke the LLM to generate a recap; capture content even on failure.</span>
        <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patch_dangling</span><span class="p">(</span>
            <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">],</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;recap&quot;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">response_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">response_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Response error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="n">Panel</span><span class="p">(</span>
                <span class="n">Markdown</span><span class="p">(</span><span class="n">response_content</span><span class="p">),</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;[bold grey85 on black]Recap of Work&quot;</span><span class="p">,</span>
                <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;grey85 on black&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;grey85 on black&quot;</span><span class="p">,</span>
                <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Make panel fit content width</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 3) Optionally persist salient details to the memory backend.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_memory</span><span class="p">:</span>
            <span class="n">memories</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Collect human/system/tool message content; for AI tool calls, store args.</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
                <span class="n">msg_content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">):</span>
                    <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_content</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_content</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tool_strings</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                        <span class="n">tool_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Tool Name: &quot;</span> <span class="o">+</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                            <span class="n">tool_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Arg: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">arg_name</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Value: &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tool</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="n">arg_name</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_strings</span><span class="p">))</span>
            <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_memory</span><span class="o">.</span><span class="n">add_memories</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">full_overwrite</span><span class="p">:</span>
            <span class="c1"># 4) Optionally write state to disk for debugging/auditing.</span>
            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_state</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span><span class="s2">&quot;execution_agent.json&quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Overwrite</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_state</span><span class="p">:</span>
                <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span><span class="s2">&quot;execution_agent.json&quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">recap_message</span><span class="p">,</span> <span class="n">response</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct and compile the agent&#39;s LangGraph state machine.&quot;&quot;&quot;</span>

        <span class="c1"># Bind tools to llm and context summarizer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># Register nodes:</span>
        <span class="c1"># - &quot;agent&quot;: LLM planning/execution step</span>
        <span class="c1"># - &quot;action&quot;: tool dispatch (run_command, write_code, etc.)</span>
        <span class="c1"># - &quot;recap&quot;: summary/finalization step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_executor</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_node</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recap</span><span class="p">,</span> <span class="s2">&quot;recap&quot;</span><span class="p">)</span>

        <span class="c1"># Set entrypoint: execution starts with the &quot;agent&quot; node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">)</span>

        <span class="c1"># From &quot;agent&quot;, either continue (tools) or finish (recap),</span>
        <span class="c1"># based on presence of tool calls in the last message.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;agent&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_cond</span><span class="p">(</span><span class="n">should_continue</span><span class="p">,</span> <span class="s2">&quot;should_continue&quot;</span><span class="p">,</span> <span class="s2">&quot;execution&quot;</span><span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;continue&quot;</span><span class="p">:</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;recap&quot;</span><span class="p">:</span> <span class="s2">&quot;recap&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># After tools run, return control to the agent for the next step.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>

        <span class="c1"># The graph completes at the &quot;recap&quot; node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;recap&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hook_storage_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">):</span>
        <span class="c1"># Record the edit operation</span>
        <span class="k">if</span> <span class="n">store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">safe_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_codes</span><span class="p">:</span>
            <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;workspace&quot;</span><span class="p">,</span> <span class="s2">&quot;safe_codes&quot;</span><span class="p">),</span>
                <span class="n">safe_code</span><span class="p">,</span>
                <span class="p">{},</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="ursa.agents.execution_agent.ExecutionAgent.query_executor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query_executor</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">runtime</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Prepare workspace, handle optional symlinks, and invoke the executor LLM.</p>
<p>This method copies the incoming state, ensures a workspace directory exists
(creating one with a default name when absent), optionally creates a symlink
described by state["symlinkdir"], sets or injects the executor system prompt
as the first message, and invokes the bound LLM. When logging is enabled,
it persists the pre-invocation state to disk.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ExecutionState (ursa.agents.execution_agent.ExecutionState)" href="#ursa.agents.execution_agent.ExecutionState">ExecutionState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current execution state. Expected keys include:
- "messages": Ordered list of System/Human/AI/Tool messages.
- "workspace": Optional path to the working directory.
- "symlinkdir": Optional dict with "source" and "dest" keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>ExecutionState</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="ExecutionState (ursa.agents.execution_agent.ExecutionState)" href="#ursa.agents.execution_agent.ExecutionState">ExecutionState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Partial state update containing:
- "messages": A list with the model's response as the latest entry.
- "workspace": The resolved workspace path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/execution_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query_executor</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">,</span> <span class="n">runtime</span><span class="p">:</span> <span class="n">Runtime</span><span class="p">[</span><span class="n">AgentContext</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecutionState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare workspace, handle optional symlinks, and invoke the executor LLM.</span>

<span class="sd">    This method copies the incoming state, ensures a workspace directory exists</span>
<span class="sd">    (creating one with a default name when absent), optionally creates a symlink</span>
<span class="sd">    described by state[&quot;symlinkdir&quot;], sets or injects the executor system prompt</span>
<span class="sd">    as the first message, and invokes the bound LLM. When logging is enabled,</span>
<span class="sd">    it persists the pre-invocation state to disk.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The current execution state. Expected keys include:</span>
<span class="sd">            - &quot;messages&quot;: Ordered list of System/Human/AI/Tool messages.</span>
<span class="sd">            - &quot;workspace&quot;: Optional path to the working directory.</span>
<span class="sd">            - &quot;symlinkdir&quot;: Optional dict with &quot;source&quot; and &quot;dest&quot; keys.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ExecutionState: Partial state update containing:</span>
<span class="sd">            - &quot;messages&quot;: A list with the model&#39;s response as the latest entry.</span>
<span class="sd">            - &quot;workspace&quot;: The resolved workspace path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add model to the state so it can be passed to tools like the URSA Arxiv or OSTI tools</span>
    <span class="n">new_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">new_state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">full_overwrite</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># 1.5) Check message history length and summarize to shorten the token usage:</span>
    <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_context</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>

    <span class="c1"># 2) Optionally create a symlink if symlinkdir is provided and not yet linked.</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">new_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sd</span> <span class="ow">and</span> <span class="s2">&quot;is_linked&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">:</span>
        <span class="c1"># symlinkdir structure: {&quot;source&quot;: &quot;/path/to/src&quot;, &quot;dest&quot;: &quot;link/name&quot;}</span>
        <span class="n">symlinkdir</span> <span class="o">=</span> <span class="n">sd</span>

        <span class="n">src</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">symlinkdir</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">symlinkdir</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">])</span>

        <span class="c1"># If a file/link already exists at the destination, replace it.</span>
        <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">dst</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># Ensure parent directories for the link exist.</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create the symlink (tell pathlib if the target is a directory).</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s2">Symlinked:</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2"> (source) --&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2"> (dest)&quot;</span><span class="p">)</span>
        <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">][</span><span class="s2">&quot;is_linked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">full_overwrite</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patch_dangling</span><span class="p">(</span>
        <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span>
    <span class="p">)</span>

    <span class="c1"># 3) Ensure the executor prompt is the first SystemMessage.</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SystemMessage</span><span class="p">):</span>
        <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor_prompt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor_prompt</span><span class="p">)]</span> <span class="o">+</span> <span class="n">messages</span>

    <span class="c1"># 4) Invoke the LLM with the prepared message sequence.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">messages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Response error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="c1"># 5) Optionally persist the pre-invocation state for audit/debugging.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_state</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span><span class="s2">&quot;execution_agent.json&quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">full_overwrite</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">Overwrite</span><span class="p">(</span><span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;symlinkdir&quot;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="s2">&quot;symlinkdir&quot;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;symlinkdir&quot;</span><span class="p">]}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.execution_agent.ExecutionAgent.recap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">recap</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Produce a concise summary of the conversation and optionally persist memory.</p>
<p>This method builds a summarization prompt, invokes the LLM to obtain a compact
summary of recent interactions, optionally logs salient details to the agent
memory backend, and writes debug state when logging is enabled.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ExecutionState (ursa.agents.execution_agent.ExecutionState)" href="#ursa.agents.execution_agent.ExecutionState">ExecutionState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The execution state containing message history.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>ExecutionState</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="ExecutionState (ursa.agents.execution_agent.ExecutionState)" href="#ursa.agents.execution_agent.ExecutionState">ExecutionState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A partial update with a single string message containing
the recap.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/execution_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">recap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecutionState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produce a concise summary of the conversation and optionally persist memory.</span>

<span class="sd">    This method builds a summarization prompt, invokes the LLM to obtain a compact</span>
<span class="sd">    summary of recent interactions, optionally logs salient details to the agent</span>
<span class="sd">    memory backend, and writes debug state when logging is enabled.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (ExecutionState): The execution state containing message history.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ExecutionState: A partial update with a single string message containing</span>
<span class="sd">            the recap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">full_overwrite</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># 0) Check message history length and summarize to shorten the token usage:</span>
    <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_context</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>

    <span class="c1"># 1) Construct the summarization message list (system prompt + prior messages).</span>
    <span class="n">recap_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recap_prompt</span><span class="p">)</span>
    <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">recap_message</span><span class="p">]</span>

    <span class="c1"># 2) Invoke the LLM to generate a recap; capture content even on failure.</span>
    <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patch_dangling</span><span class="p">(</span>
        <span class="n">new_state</span><span class="p">,</span> <span class="n">full_overwrite</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;recap&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">response_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">response_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Response error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
        <span class="n">Panel</span><span class="p">(</span>
            <span class="n">Markdown</span><span class="p">(</span><span class="n">response_content</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;[bold grey85 on black]Recap of Work&quot;</span><span class="p">,</span>
            <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;grey85 on black&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="s2">&quot;grey85 on black&quot;</span><span class="p">,</span>
            <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Make panel fit content width</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 3) Optionally persist salient details to the memory backend.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_memory</span><span class="p">:</span>
        <span class="n">memories</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Collect human/system/tool message content; for AI tool calls, store args.</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
            <span class="n">msg_content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">):</span>
                <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_content</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tool_strings</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">tool_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Tool Name: &quot;</span> <span class="o">+</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                        <span class="n">tool_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Arg: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">arg_name</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Value: &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tool</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="n">arg_name</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_strings</span><span class="p">))</span>
        <span class="n">memories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_memory</span><span class="o">.</span><span class="n">add_memories</span><span class="p">(</span><span class="n">memories</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_overwrite</span><span class="p">:</span>
        <span class="c1"># 4) Optionally write state to disk for debugging/auditing.</span>
        <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span><span class="s2">&quot;execution_agent.json&quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Overwrite</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_state</span><span class="p">:</span>
            <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_state</span><span class="p">(</span><span class="s2">&quot;execution_agent.json&quot;</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">recap_message</span><span class="p">,</span> <span class="n">response</span><span class="p">]}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ursa.agents.execution_agent.ExecutionState" class="doc doc-heading">
            <code>ExecutionState</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.TypedDict">TypedDict</span></code></p>


        <p>TypedDict representing the execution agent's mutable run state used by nodes.</p>
<p>Fields:
- messages: list of messages (System/Human/AI/Tool).
- symlinkdir: optional dict describing a symlink operation (source, dest,
  is_linked).</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/execution_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ExecutionState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TypedDict representing the execution agent&#39;s mutable run state used by nodes.</span>

<span class="sd">    Fields:</span>
<span class="sd">    - messages: list of messages (System/Human/AI/Tool).</span>
<span class="sd">    - symlinkdir: optional dict describing a symlink operation (source, dest,</span>
<span class="sd">      is_linked).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">add_messages</span><span class="p">]</span>
    <span class="n">symlinkdir</span><span class="p">:</span> <span class="nb">dict</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="ursa.agents.execution_agent.command_safe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">command_safe</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return 'safe' if the last command was safe, otherwise 'unsafe'.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ExecutionState (ursa.agents.execution_agent.ExecutionState)" href="#ursa.agents.execution_agent.ExecutionState">ExecutionState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current execution state containing messages and tool calls.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    A literal "safe" if no '[UNSAFE]' tags are in the last command,
    otherwise "unsafe".</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/execution_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">command_safe</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;safe&quot;</span><span class="p">,</span> <span class="s2">&quot;unsafe&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return &#39;safe&#39; if the last command was safe, otherwise &#39;unsafe&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The current execution state containing messages and tool calls.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A literal &quot;safe&quot; if no &#39;[UNSAFE]&#39; tags are in the last command,</span>
<span class="sd">        otherwise &quot;unsafe&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
    <span class="c1"># Loop through all the consecutive tool messages in reverse order</span>
    <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">ToolMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;[UNSAFE]&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;unsafe&quot;</span>

        <span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>

    <span class="k">return</span> <span class="s2">&quot;safe&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ursa.agents.execution_agent.should_continue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">should_continue</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return 'recap' if no tool calls in the last message, else 'continue'.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ExecutionState (ursa.agents.execution_agent.ExecutionState)" href="#ursa.agents.execution_agent.ExecutionState">ExecutionState</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current execution state containing messages.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;recap&#39;, &#39;continue&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A literal "recap" if the last message has no tool calls,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;recap&#39;, &#39;continue&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>otherwise "continue".</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/execution_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">should_continue</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ExecutionState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;recap&quot;</span><span class="p">,</span> <span class="s2">&quot;continue&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return &#39;recap&#39; if no tool calls in the last message, else &#39;continue&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The current execution state containing messages.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A literal &quot;recap&quot; if the last message has no tool calls,</span>
<span class="sd">        otherwise &quot;continue&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>
    <span class="n">last_message</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># If there is no tool call, then we finish</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;recap&quot;</span>
    <span class="c1"># Otherwise if there is, we continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;continue&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.hypothesizer_agent" class="doc doc-heading">
            <code>hypothesizer_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.hypothesizer_agent.HypothesizerAgent" class="doc doc-heading">
            <code>HypothesizerAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a>[<span title="ursa.agents.hypothesizer_agent.HypothesizerState">HypothesizerState</span>]</code></p>









              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/hypothesizer_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HypothesizerAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">[</span><span class="n">HypothesizerState</span><span class="p">]):</span>
    <span class="n">state_type</span> <span class="o">=</span> <span class="n">HypothesizerState</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypothesizer_prompt</span> <span class="o">=</span> <span class="n">hypothesizer_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critic_prompt</span> <span class="o">=</span> <span class="n">critic_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">competitor_prompt</span> <span class="o">=</span> <span class="n">competitor_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_tool</span> <span class="o">=</span> <span class="n">DDGS</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">HypothesizerState</span><span class="p">(</span>
                <span class="n">question</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
                <span class="n">max_iterations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
                <span class="n">current_iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">HypothesizerState</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">HypothesizerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;solution&quot;</span><span class="p">,</span> <span class="s2">&quot;Hypothesizer failed to return a solution&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_visited_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_search_results</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">visited_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_search_results</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">raw_search_results</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="n">raw_search_results</span>
            <span class="c1"># Each item typically might have &quot;link&quot;, &quot;title&quot;, &quot;snippet&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                    <span class="n">visited_sites</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="c1"># If it&#39;s not valid Python syntax or something else goes wrong</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Could not parse search results as Python list.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] raw_search_results:&quot;</span><span class="p">,</span> <span class="n">raw_search_results</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">visited_sites</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">agent1_generate_solution</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Agent 1: Hypothesizer.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Entering agent1_generate_solution. Iteration: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">current_iter</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_iteration&quot;</span><span class="p">]</span>
        <span class="n">user_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">current_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">user_content</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Previous solution: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;agent1_solution&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Critique: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;agent2_critiques&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">user_content</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Competitor perspective: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;agent3_perspectives&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">user_content</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">**You must explicitly list how this new solution differs from the previous solution,** &quot;</span>
                <span class="s2">&quot;point by point, explaining what changes were made in response to the critique and competitor perspective.&quot;</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Afterward, provide your updated solution.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_content</span> <span class="o">+=</span> <span class="s2">&quot;Research this problem and generate a solution.&quot;</span>

        <span class="n">search_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Here is a problem description: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Turn it into a short query to be fed into a search engine.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">search_query</span><span class="p">:</span>
            <span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_search_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_tool</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">search_query</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Search results: </span><span class="si">{</span><span class="n">raw_search_results</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Parse the results if possible, so we can collect URLs</span>
        <span class="n">visited_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_visited_sites</span><span class="p">(</span><span class="n">raw_search_results</span><span class="p">)</span>

        <span class="c1"># Provide a system message to define this agent&#39;s role</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesizer_prompt</span><span class="p">),</span>
            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_content</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># Print the entire solution in green</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">[Agent1 - Hypothesizer solution]</span><span class="se">\n</span><span class="si">{</span><span class="n">solution</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Exiting agent1_generate_solution.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;agent1_solution&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">solution</span><span class="p">],</span>
            <span class="s2">&quot;question_search_query&quot;</span><span class="p">:</span> <span class="n">search_query</span><span class="p">,</span>
            <span class="s2">&quot;visited_sites&quot;</span><span class="p">:</span> <span class="n">visited_sites</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">agent2_critique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Agent 2: Critic.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Entering agent2_critique.&quot;</span>
        <span class="p">)</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">user_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Proposed solution: </span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Provide a detailed critique of this solution. Identify potential flaws, assumptions, and areas for improvement.&quot;</span>
        <span class="p">)</span>

        <span class="n">fact_check_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fact check </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_search_query&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> solution effectiveness&quot;</span>

        <span class="n">fact_check_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_tool</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">fact_check_query</span><span class="p">)</span>
        <span class="n">visited_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_visited_sites</span><span class="p">(</span><span class="n">fact_check_results</span><span class="p">)</span>
        <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fact check results: </span><span class="si">{</span><span class="n">fact_check_results</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">critic_prompt</span><span class="p">),</span>
            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_content</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">critique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># Print the entire critique in blue</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">[Agent2 - Critic]</span><span class="se">\n</span><span class="si">{</span><span class="n">critique</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Exiting agent2_critique.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;agent2_critiques&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">critique</span><span class="p">],</span>
            <span class="s2">&quot;visited_sites&quot;</span><span class="p">:</span> <span class="n">visited_sites</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">agent3_competitor_perspective</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Agent 3: Competitor/Stakeholder Simulator.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Entering agent3_competitor_perspective.&quot;</span>
        <span class="p">)</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">critique</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent2_critiques&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">user_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Proposed solution: </span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Critique: </span><span class="si">{</span><span class="n">critique</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Simulate how a competitor, government agency, or other stakeholder might respond to this solution.&quot;</span>
        <span class="p">)</span>

        <span class="n">competitor_search_query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;competitor responses to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_search_query&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">competitor_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_tool</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">competitor_search_query</span><span class="p">)</span>
        <span class="n">visited_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_visited_sites</span><span class="p">(</span><span class="n">competitor_info</span><span class="p">)</span>
        <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Competitor information: </span><span class="si">{</span><span class="n">competitor_info</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">competitor_prompt</span><span class="p">),</span>
            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_content</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">perspective</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># Print the entire perspective in red</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s2">[Agent3 - Competitor/Stakeholder Perspective]</span><span class="se">\n</span><span class="si">{</span><span class="n">perspective</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Exiting agent3_competitor_perspective.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;agent3_perspectives&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">perspective</span><span class="p">],</span>
            <span class="s2">&quot;visited_sites&quot;</span><span class="p">:</span> <span class="n">visited_sites</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">increment_iteration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
        <span class="n">current_iteration</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_iteration&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;current_iteration&quot;</span><span class="p">:</span> <span class="n">current_iteration</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the overall, refined solution based on all iterations.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Entering generate_solution.&quot;</span>
        <span class="p">)</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Original question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;Evolution of solutions:</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">solution_text</span><span class="p">,</span> <span class="n">critique_text</span><span class="p">,</span> <span class="n">perspective_text</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">],</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent2_critiques&quot;</span><span class="p">],</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent3_perspectives&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Solution: </span><span class="si">{</span><span class="n">solution_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Critique: </span><span class="si">{</span><span class="n">critique_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Competitor perspective: </span><span class="si">{</span><span class="n">perspective_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Based on this iterative process, provide the overall, refined solution.&quot;</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Generating overall solution with LLM...&quot;</span>
        <span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Overall solution obtained. Preview:&quot;</span><span class="p">,</span>
            <span class="n">solution</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span>
            <span class="s2">&quot;...&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Exiting generate_solution.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_visited_sites</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># all_sites = list(new_state[&quot;visited_sites&quot;])</span>
        <span class="c1"># print(&quot;[DEBUG] Visited Sites:&quot;)</span>
        <span class="c1"># for s in all_sites:</span>
        <span class="c1">#     print(&quot;  &quot;, s)</span>
        <span class="k">return</span> <span class="n">new_state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summarize_process_as_latex</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize how the solution changed over time, referencing</span>
<span class="sd">        each iteration&#39;s critique and competitor perspective,</span>
<span class="sd">        then produce a final LaTeX document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entering summarize_process_as_latex.&quot;</span><span class="p">)</span>
        <span class="c1"># Build a single string describing the entire iterative process</span>
        <span class="n">iteration_details</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">],</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent2_critiques&quot;</span><span class="p">],</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent3_perspectives&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">iteration_details</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">subsection*</span><span class="se">{{</span><span class="s2">Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">}}\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">textbf</span><span class="se">{{</span><span class="s2">Solution:</span><span class="se">}}\\\\\n</span><span class="si">{</span><span class="n">sol</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">textbf</span><span class="se">{{</span><span class="s2">Critique:</span><span class="se">}}\\\\\n</span><span class="si">{</span><span class="n">crit</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">textbf</span><span class="se">{{</span><span class="s2">Competitor Perspective:</span><span class="se">}}\\\\\n</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># -----------------------------</span>
        <span class="c1"># Write iteration_details to disk as .txt</span>
        <span class="c1"># -----------------------------</span>
        <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
        <span class="n">txt_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;iteration_details_</span><span class="si">{</span><span class="n">timestamp_str</span><span class="si">}</span><span class="s2">_chat_history.txt&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iteration_details</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote iteration details to </span><span class="si">{</span><span class="n">txt_filename</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Prompt the LLM to produce a LaTeX doc</span>
        <span class="c1"># We&#39;ll just pass it as a single string to the LLM;</span>
        <span class="c1"># you could also do system+human messages if you prefer.</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            You are a system that produces a FULL LaTeX document.</span>
<span class="s2">            Here is information about a multi-iteration process:</span>

<span class="s2">            Original question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">            Below are the solutions, critiques, and competitor perspectives from each iteration:</span>

<span class="s2">            </span><span class="si">{</span><span class="n">iteration_details</span><span class="si">}</span>

<span class="s2">            The solution we arrived at was:</span>

<span class="s2">            </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">            Now produce a valid LaTeX document.  Be sure to use a table of contents.</span>
<span class="s2">            It must start with an Executive Summary (that may be multiple pages) which summarizes</span>
<span class="s2">            the entire iterative process.  Following that, we should include the solution in full,</span>
<span class="s2">            not summarized, but reformatted for appropriate LaTeX.  And then, finally (and this will be</span>
<span class="s2">            quite long), we must take all the steps - solutions, critiques, and competitor perspectives</span>
<span class="s2">            and *NOT SUMMARIZE THEM* but merely reformat them for the reader.  This will be in an Appendix</span>
<span class="s2">            of the full content of the steps.  Finally, include a listing of all of the websites we</span>
<span class="s2">            used in our research.</span>

<span class="s2">            You must ONLY RETURN LaTeX, nothing else.  It must be valid LaTeX syntax!</span>

<span class="s2">            Your output should start with:</span>
<span class="s2">            </span><span class="se">\\</span><span class="s2">documentclass</span><span class="se">{{</span><span class="s2">article</span><span class="se">}}</span>
<span class="s2">            </span><span class="se">\\</span><span class="s2">usepackage[margin=1in]</span><span class="se">{{</span><span class="s2">geometry</span><span class="se">}}</span>
<span class="s2">            etc.</span>

<span class="s2">            It must compile without errors under pdflatex.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="c1"># Now produce a valid LaTeX document that nicely summarizes this entire iterative process.</span>
        <span class="c1"># It must include the overall solution in full, not summarized, but reformatted for appropriate</span>
        <span class="c1"># LaTeX. The summarization is for the other steps.</span>

        <span class="c1"># all_visited_sites = list(state[&quot;visited_sites&quot;])</span>
        <span class="c1"># (Optional) remove duplicates by converting to a set, then back to a list</span>
        <span class="c1"># visited_sites_unique = list(set(all_visited_sites))</span>
        <span class="c1"># if visited_sites_unique:</span>
        <span class="c1">#     websites_latex = &quot;\\section*{Websites Visited}\\begin{itemize}\n&quot;</span>
        <span class="c1">#     for url in visited_sites_unique:</span>
        <span class="c1">#         print(f&quot;We visited: {url}&quot;)</span>
        <span class="c1">#         # Use \url{} to handle special characters in URLs</span>
        <span class="c1">#         websites_latex += f&quot;\\item \\url{{{url}}}\n&quot;</span>
        <span class="c1">#     websites_latex += &quot;\\end{itemize}\n\n&quot;</span>
        <span class="c1"># else:</span>
        <span class="c1">#     # If no sites visited, or the list is empty</span>
        <span class="c1">#     websites_latex = (</span>
        <span class="c1">#         &quot;\\section*{Websites Visited}\nNo sites were visited.\n\n&quot;</span>
        <span class="c1">#     )</span>
        <span class="c1"># print(websites_latex)</span>
        <span class="n">websites_latex</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Ask the LLM to produce *only* LaTeX content</span>
        <span class="n">latex_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

        <span class="n">latex_doc</span> <span class="o">=</span> <span class="n">latex_response</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">inject_into_latex</span><span class="p">(</span><span class="n">original_tex</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">injection</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Find the last occurrence of &#39;\\end{document}&#39; in &#39;original_tex&#39;</span>
<span class="sd">            and insert &#39;injection&#39; right before it.</span>
<span class="sd">            If &#39;\\end{document}&#39; is not found, just append the injection at the end.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">injection_index</span> <span class="o">=</span> <span class="n">original_tex</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{document}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">injection_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If the LLM didn&#39;t include \end{document}, just append</span>
                <span class="k">return</span> <span class="n">original_tex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">injection</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Insert right before \end{document}</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">original_tex</span><span class="p">[:</span><span class="n">injection_index</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">injection</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">original_tex</span><span class="p">[</span><span class="n">injection_index</span><span class="p">:]</span>
                <span class="p">)</span>

        <span class="n">final_latex</span> <span class="o">=</span> <span class="n">inject_into_latex</span><span class="p">(</span><span class="n">latex_doc</span><span class="p">,</span> <span class="n">websites_latex</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Received LaTeX from LLM. Preview:&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">latex_response</span><span class="p">[:</span><span class="mi">300</span><span class="p">],</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Exiting summarize_process_as_latex.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;summary_report&quot;</span><span class="p">:</span> <span class="n">final_latex</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Add nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent1_generate_solution</span><span class="p">,</span> <span class="s2">&quot;agent1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent2_critique</span><span class="p">,</span> <span class="s2">&quot;agent2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent3_competitor_perspective</span><span class="p">,</span> <span class="s2">&quot;agent3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">increment_iteration</span><span class="p">,</span> <span class="s2">&quot;increment_iteration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_solution</span><span class="p">,</span> <span class="s2">&quot;finalize&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">print_visited_sites</span><span class="p">,</span> <span class="s2">&quot;print_sites&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summarize_process_as_latex</span><span class="p">,</span> <span class="s2">&quot;summarize_as_latex&quot;</span><span class="p">)</span>

        <span class="c1"># Add simple edges for the known flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;agent1&quot;</span><span class="p">,</span> <span class="s2">&quot;agent2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;agent2&quot;</span><span class="p">,</span> <span class="s2">&quot;agent3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;agent3&quot;</span><span class="p">,</span> <span class="s2">&quot;increment_iteration&quot;</span><span class="p">)</span>

        <span class="c1"># Then from increment_iteration, we have a conditional:</span>
        <span class="c1"># If we &#39;continue&#39;, we go back to agent1</span>
        <span class="c1"># If we &#39;finish&#39;, we jump to the finalize node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;increment_iteration&quot;</span><span class="p">,</span>
            <span class="n">should_continue</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;continue&quot;</span><span class="p">:</span> <span class="s2">&quot;agent1&quot;</span><span class="p">,</span> <span class="s2">&quot;finish&quot;</span><span class="p">:</span> <span class="s2">&quot;finalize&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;finalize&quot;</span><span class="p">,</span> <span class="s2">&quot;summarize_as_latex&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;summarize_as_latex&quot;</span><span class="p">,</span> <span class="s2">&quot;print_sites&quot;</span><span class="p">)</span>
        <span class="c1"># self.graph.add_edge(&quot;summarize_as_latex&quot;, &quot;compile_pdf&quot;)</span>
        <span class="c1"># self.graph.add_edge(&quot;compile_pdf&quot;, &quot;print_sites&quot;)</span>

        <span class="c1"># Set the entry point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;agent1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;print_sites&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="ursa.agents.hypothesizer_agent.HypothesizerAgent.agent1_generate_solution" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">agent1_generate_solution</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Agent 1: Hypothesizer.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/hypothesizer_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">agent1_generate_solution</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent 1: Hypothesizer.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Entering agent1_generate_solution. Iteration: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">current_iter</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_iteration&quot;</span><span class="p">]</span>
    <span class="n">user_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">current_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">user_content</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Previous solution: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;agent1_solution&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Critique: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;agent2_critiques&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">user_content</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Competitor perspective: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;agent3_perspectives&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">user_content</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">**You must explicitly list how this new solution differs from the previous solution,** &quot;</span>
            <span class="s2">&quot;point by point, explaining what changes were made in response to the critique and competitor perspective.&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Afterward, provide your updated solution.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_content</span> <span class="o">+=</span> <span class="s2">&quot;Research this problem and generate a solution.&quot;</span>

    <span class="n">search_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Here is a problem description: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Turn it into a short query to be fed into a search engine.&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">search_query</span><span class="p">:</span>
        <span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">raw_search_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_tool</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">search_query</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Search results: </span><span class="si">{</span><span class="n">raw_search_results</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Parse the results if possible, so we can collect URLs</span>
    <span class="n">visited_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_visited_sites</span><span class="p">(</span><span class="n">raw_search_results</span><span class="p">)</span>

    <span class="c1"># Provide a system message to define this agent&#39;s role</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesizer_prompt</span><span class="p">),</span>
        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_content</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

    <span class="c1"># Print the entire solution in green</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">[Agent1 - Hypothesizer solution]</span><span class="se">\n</span><span class="si">{</span><span class="n">solution</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Exiting agent1_generate_solution.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;agent1_solution&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">solution</span><span class="p">],</span>
        <span class="s2">&quot;question_search_query&quot;</span><span class="p">:</span> <span class="n">search_query</span><span class="p">,</span>
        <span class="s2">&quot;visited_sites&quot;</span><span class="p">:</span> <span class="n">visited_sites</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.hypothesizer_agent.HypothesizerAgent.agent2_critique" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">agent2_critique</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Agent 2: Critic.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/hypothesizer_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">agent2_critique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent 2: Critic.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Entering agent2_critique.&quot;</span>
    <span class="p">)</span>

    <span class="n">solution</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">user_content</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Proposed solution: </span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Provide a detailed critique of this solution. Identify potential flaws, assumptions, and areas for improvement.&quot;</span>
    <span class="p">)</span>

    <span class="n">fact_check_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fact check </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_search_query&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> solution effectiveness&quot;</span>

    <span class="n">fact_check_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_tool</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">fact_check_query</span><span class="p">)</span>
    <span class="n">visited_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_visited_sites</span><span class="p">(</span><span class="n">fact_check_results</span><span class="p">)</span>
    <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fact check results: </span><span class="si">{</span><span class="n">fact_check_results</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">critic_prompt</span><span class="p">),</span>
        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_content</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">critique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

    <span class="c1"># Print the entire critique in blue</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">[Agent2 - Critic]</span><span class="se">\n</span><span class="si">{</span><span class="n">critique</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Exiting agent2_critique.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;agent2_critiques&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">critique</span><span class="p">],</span>
        <span class="s2">&quot;visited_sites&quot;</span><span class="p">:</span> <span class="n">visited_sites</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.hypothesizer_agent.HypothesizerAgent.agent3_competitor_perspective" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">agent3_competitor_perspective</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Agent 3: Competitor/Stakeholder Simulator.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/hypothesizer_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">agent3_competitor_perspective</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent 3: Competitor/Stakeholder Simulator.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Entering agent3_competitor_perspective.&quot;</span>
    <span class="p">)</span>

    <span class="n">solution</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">critique</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent2_critiques&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">user_content</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Proposed solution: </span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Critique: </span><span class="si">{</span><span class="n">critique</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Simulate how a competitor, government agency, or other stakeholder might respond to this solution.&quot;</span>
    <span class="p">)</span>

    <span class="n">competitor_search_query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;competitor responses to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question_search_query&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">competitor_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_tool</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">competitor_search_query</span><span class="p">)</span>
    <span class="n">visited_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_visited_sites</span><span class="p">(</span><span class="n">competitor_info</span><span class="p">)</span>
    <span class="n">user_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Competitor information: </span><span class="si">{</span><span class="n">competitor_info</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">competitor_prompt</span><span class="p">),</span>
        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_content</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">perspective</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

    <span class="c1"># Print the entire perspective in red</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s2">[Agent3 - Competitor/Stakeholder Perspective]</span><span class="se">\n</span><span class="si">{</span><span class="n">perspective</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] Exiting agent3_competitor_perspective.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;agent3_perspectives&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">perspective</span><span class="p">],</span>
        <span class="s2">&quot;visited_sites&quot;</span><span class="p">:</span> <span class="n">visited_sites</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.hypothesizer_agent.HypothesizerAgent.generate_solution" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_solution</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate the overall, refined solution based on all iterations.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/hypothesizer_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the overall, refined solution based on all iterations.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Entering generate_solution.&quot;</span>
    <span class="p">)</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Original question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;Evolution of solutions:</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">solution_text</span><span class="p">,</span> <span class="n">critique_text</span><span class="p">,</span> <span class="n">perspective_text</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">],</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent2_critiques&quot;</span><span class="p">],</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent3_perspectives&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Solution: </span><span class="si">{</span><span class="n">solution_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Critique: </span><span class="si">{</span><span class="n">critique_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Competitor perspective: </span><span class="si">{</span><span class="n">perspective_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Based on this iterative process, provide the overall, refined solution.&quot;</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Generating overall solution with LLM...&quot;</span>
    <span class="p">)</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Overall solution obtained. Preview:&quot;</span><span class="p">,</span>
        <span class="n">solution</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span>
        <span class="s2">&quot;...&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Exiting generate_solution.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ursa.agents.hypothesizer_agent.HypothesizerAgent.summarize_process_as_latex" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">summarize_process_as_latex</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Summarize how the solution changed over time, referencing
each iteration's critique and competitor perspective,
then produce a final LaTeX document.</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/hypothesizer_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">summarize_process_as_latex</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">HypothesizerState</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HypothesizerState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summarize how the solution changed over time, referencing</span>
<span class="sd">    each iteration&#39;s critique and competitor perspective,</span>
<span class="sd">    then produce a final LaTeX document.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entering summarize_process_as_latex.&quot;</span><span class="p">)</span>
    <span class="c1"># Build a single string describing the entire iterative process</span>
    <span class="n">iteration_details</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent1_solution&quot;</span><span class="p">],</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent2_critiques&quot;</span><span class="p">],</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agent3_perspectives&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">iteration_details</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">subsection*</span><span class="se">{{</span><span class="s2">Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">}}\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">textbf</span><span class="se">{{</span><span class="s2">Solution:</span><span class="se">}}\\\\\n</span><span class="si">{</span><span class="n">sol</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">textbf</span><span class="se">{{</span><span class="s2">Critique:</span><span class="se">}}\\\\\n</span><span class="si">{</span><span class="n">crit</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">textbf</span><span class="se">{{</span><span class="s2">Competitor Perspective:</span><span class="se">}}\\\\\n</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># -----------------------------</span>
    <span class="c1"># Write iteration_details to disk as .txt</span>
    <span class="c1"># -----------------------------</span>
    <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
    <span class="n">txt_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;iteration_details_</span><span class="si">{</span><span class="n">timestamp_str</span><span class="si">}</span><span class="s2">_chat_history.txt&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iteration_details</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote iteration details to </span><span class="si">{</span><span class="n">txt_filename</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># Prompt the LLM to produce a LaTeX doc</span>
    <span class="c1"># We&#39;ll just pass it as a single string to the LLM;</span>
    <span class="c1"># you could also do system+human messages if you prefer.</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        You are a system that produces a FULL LaTeX document.</span>
<span class="s2">        Here is information about a multi-iteration process:</span>

<span class="s2">        Original question: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Below are the solutions, critiques, and competitor perspectives from each iteration:</span>

<span class="s2">        </span><span class="si">{</span><span class="n">iteration_details</span><span class="si">}</span>

<span class="s2">        The solution we arrived at was:</span>

<span class="s2">        </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;solution&quot;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        Now produce a valid LaTeX document.  Be sure to use a table of contents.</span>
<span class="s2">        It must start with an Executive Summary (that may be multiple pages) which summarizes</span>
<span class="s2">        the entire iterative process.  Following that, we should include the solution in full,</span>
<span class="s2">        not summarized, but reformatted for appropriate LaTeX.  And then, finally (and this will be</span>
<span class="s2">        quite long), we must take all the steps - solutions, critiques, and competitor perspectives</span>
<span class="s2">        and *NOT SUMMARIZE THEM* but merely reformat them for the reader.  This will be in an Appendix</span>
<span class="s2">        of the full content of the steps.  Finally, include a listing of all of the websites we</span>
<span class="s2">        used in our research.</span>

<span class="s2">        You must ONLY RETURN LaTeX, nothing else.  It must be valid LaTeX syntax!</span>

<span class="s2">        Your output should start with:</span>
<span class="s2">        </span><span class="se">\\</span><span class="s2">documentclass</span><span class="se">{{</span><span class="s2">article</span><span class="se">}}</span>
<span class="s2">        </span><span class="se">\\</span><span class="s2">usepackage[margin=1in]</span><span class="se">{{</span><span class="s2">geometry</span><span class="se">}}</span>
<span class="s2">        etc.</span>

<span class="s2">        It must compile without errors under pdflatex.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Now produce a valid LaTeX document that nicely summarizes this entire iterative process.</span>
    <span class="c1"># It must include the overall solution in full, not summarized, but reformatted for appropriate</span>
    <span class="c1"># LaTeX. The summarization is for the other steps.</span>

    <span class="c1"># all_visited_sites = list(state[&quot;visited_sites&quot;])</span>
    <span class="c1"># (Optional) remove duplicates by converting to a set, then back to a list</span>
    <span class="c1"># visited_sites_unique = list(set(all_visited_sites))</span>
    <span class="c1"># if visited_sites_unique:</span>
    <span class="c1">#     websites_latex = &quot;\\section*{Websites Visited}\\begin{itemize}\n&quot;</span>
    <span class="c1">#     for url in visited_sites_unique:</span>
    <span class="c1">#         print(f&quot;We visited: {url}&quot;)</span>
    <span class="c1">#         # Use \url{} to handle special characters in URLs</span>
    <span class="c1">#         websites_latex += f&quot;\\item \\url{{{url}}}\n&quot;</span>
    <span class="c1">#     websites_latex += &quot;\\end{itemize}\n\n&quot;</span>
    <span class="c1"># else:</span>
    <span class="c1">#     # If no sites visited, or the list is empty</span>
    <span class="c1">#     websites_latex = (</span>
    <span class="c1">#         &quot;\\section*{Websites Visited}\nNo sites were visited.\n\n&quot;</span>
    <span class="c1">#     )</span>
    <span class="c1"># print(websites_latex)</span>
    <span class="n">websites_latex</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Ask the LLM to produce *only* LaTeX content</span>
    <span class="n">latex_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strllm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="n">latex_doc</span> <span class="o">=</span> <span class="n">latex_response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inject_into_latex</span><span class="p">(</span><span class="n">original_tex</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">injection</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the last occurrence of &#39;\\end{document}&#39; in &#39;original_tex&#39;</span>
<span class="sd">        and insert &#39;injection&#39; right before it.</span>
<span class="sd">        If &#39;\\end{document}&#39; is not found, just append the injection at the end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">injection_index</span> <span class="o">=</span> <span class="n">original_tex</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{document}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">injection_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If the LLM didn&#39;t include \end{document}, just append</span>
            <span class="k">return</span> <span class="n">original_tex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">injection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Insert right before \end{document}</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">original_tex</span><span class="p">[:</span><span class="n">injection_index</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="n">injection</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="n">original_tex</span><span class="p">[</span><span class="n">injection_index</span><span class="p">:]</span>
            <span class="p">)</span>

    <span class="n">final_latex</span> <span class="o">=</span> <span class="n">inject_into_latex</span><span class="p">(</span><span class="n">latex_doc</span><span class="p">,</span> <span class="n">websites_latex</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Received LaTeX from LLM. Preview:&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">latex_response</span><span class="p">[:</span><span class="mi">300</span><span class="p">],</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[iteration </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_iteration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] Exiting summarize_process_as_latex.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;summary_report&quot;</span><span class="p">:</span> <span class="n">final_latex</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.lammps_agent" class="doc doc-heading">
            <code>lammps_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.lammps_agent.LammpsAgent" class="doc doc-heading">
            <code>LammpsAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a>[<span title="ursa.agents.lammps_agent.LammpsState">LammpsState</span>]</code></p>









              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/lammps_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LammpsAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">[</span><span class="n">LammpsState</span><span class="p">]):</span>
    <span class="n">state_type</span> <span class="o">=</span> <span class="n">LammpsState</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="n">potential_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pair_style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pair_coeff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_potentials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_fix_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">find_potential_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">data_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_max_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">ngpus</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">mpi_procs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">workspace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./workspace&quot;</span><span class="p">,</span>
        <span class="n">lammps_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lmp_mpi&quot;</span><span class="p">,</span>
        <span class="n">mpirun_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mpirun&quot;</span><span class="p">,</span>
        <span class="n">tiktoken_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-5-mini&quot;</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">,</span>
        <span class="n">summarize_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">working</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;LAMMPS agent requires the atomman and trafilatura dependencies. These can be installed using &#39;pip install ursa-ai[lammps]&#39; or, if working from a local installation, &#39;pip install -e .[lammps]&#39; .&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_potential_files</span> <span class="o">=</span> <span class="n">potential_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_pair_style</span> <span class="o">=</span> <span class="n">pair_style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_pair_coeff</span> <span class="o">=</span> <span class="n">pair_coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_user_potential</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">potential_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">pair_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">pair_coeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_potentials</span> <span class="o">=</span> <span class="n">max_potentials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_fix_attempts</span> <span class="o">=</span> <span class="n">max_fix_attempts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_potential_only</span> <span class="o">=</span> <span class="n">find_potential_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_file</span> <span class="o">=</span> <span class="n">data_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_max_lines</span> <span class="o">=</span> <span class="n">data_max_lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngpus</span> <span class="o">=</span> <span class="n">ngpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span> <span class="o">=</span> <span class="n">mpi_procs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lammps_cmd</span> <span class="o">=</span> <span class="n">lammps_cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpirun_cmd</span> <span class="o">=</span> <span class="n">mpirun_cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tiktoken_model</span> <span class="o">=</span> <span class="n">tiktoken_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">=</span> <span class="n">max_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarize_results</span> <span class="o">=</span> <span class="n">summarize_results</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pair_styles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;eam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eam/alloy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eam/fs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;meam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kim&quot;</span><span class="p">,</span>
            <span class="s2">&quot;snap&quot;</span><span class="p">,</span>
            <span class="s2">&quot;quip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mlip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nep&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">workspace</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">str_parser</span> <span class="o">=</span> <span class="n">StrOutputParser</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summ_chain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
                <span class="s2">&quot;Here is some data about an interatomic potential: </span><span class="si">{metadata}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Briefly summarize why it could be useful for this task: </span><span class="si">{simulation_task}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_parser</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">choose_chain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
                <span class="s2">&quot;Here are the summaries of a certain number of interatomic potentials: </span><span class="si">{summaries_combined}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Pick one potential which would be most useful for this task: </span><span class="si">{simulation_task}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Return your answer **only** as valid JSON, with no extra text or formatting.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Use this exact schema:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;{{</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s1">&#39;  &quot;Chosen index&quot;: &lt;int&gt;,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;  &quot;rationale&quot;: &quot;&lt;string&gt;&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;  &quot;Potential name&quot;: &quot;&lt;string&gt;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s2">&quot;}}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_parser</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">author_chain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
                <span class="s2">&quot;Your task is to write a LAMMPS input file for this purpose: </span><span class="si">{simulation_task}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Note that all potential files are in the &#39;./&#39; directory.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Here is some information about the pair_style and pair_coeff that might be useful in writing the input file: </span><span class="si">{pair_info}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;If a template for the input file is provided, you should adapt it appropriately to meet the task requirements.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Template provided (if any): </span><span class="si">{template}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;If a data file is provided, use it in the input script via the &#39;read_data&#39; command.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Name of data file (if any): </span><span class="si">{data_file}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;First few lines of data file (if any):</span><span class="se">\n</span><span class="si">{data_content}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Ensure that all logs are recorded in a &#39;./log.lammps&#39; file.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;To create the log file, use may use the &#39;log ./log.lammps&#39; command. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Return your answer **only** as valid JSON, with no extra text or formatting.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;IMPORTANT: Properly escape all special characters in the input_script string (use </span><span class="se">\\</span><span class="s2">n for newlines, </span><span class="se">\\\\</span><span class="s2"> for backslashes, etc.).</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Use this exact schema:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;{{</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s1">&#39;  &quot;input_script&quot;: &quot;&lt;string&gt;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s2">&quot;}}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_parser</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fix_chain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
                <span class="s2">&quot;You are part of a larger scientific workflow whose purpose is to accomplish this task: </span><span class="si">{simulation_task}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Multiple attempts at writing and running a LAMMPS input file have been made.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Here is the run history across attempts (each includes the input script and its stdout/stderr):</span><span class="si">{err_message}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Use the history to identify what changed between attempts and avoid repeating failed approaches.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Your task is to write a new input file that resolves the latest error.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Note that all potential files are in the &#39;./&#39; directory.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Here is some information about the pair_style and pair_coeff that might be useful in writing the input file: </span><span class="si">{pair_info}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;If a template for the input file is provided, you should adapt it appropriately to meet the task requirements.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Template provided (if any): </span><span class="si">{template}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;If a data file is provided, use it in the input script via the &#39;read_data&#39; command.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Name of data file (if any): </span><span class="si">{data_file}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;First few lines of data file (if any):</span><span class="se">\n</span><span class="si">{data_content}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Ensure that all logs are recorded in a &#39;./log.lammps&#39; file.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;To create the log file, use may use the &#39;log ./log.lammps&#39; command. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Return your answer **only** as valid JSON, with no extra text or formatting.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;IMPORTANT: Properly escape all special characters in the input_script string (use </span><span class="se">\\</span><span class="s2">n for newlines, </span><span class="se">\\\\</span><span class="s2"> for backslashes, etc.).</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Use this exact schema:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;{{</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s1">&#39;  &quot;input_script&quot;: &quot;&lt;string&gt;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s2">&quot;}}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_parser</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold cyan]</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">[/bold cyan]&quot;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cyan&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="n">Panel</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[bold]</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">,</span> <span class="n">border_style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_code_panel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">syn</span> <span class="o">=</span> <span class="n">Syntax</span><span class="p">(</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;monokai&quot;</span><span class="p">,</span> <span class="n">line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">word_wrap</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="n">Panel</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[bold]</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">,</span> <span class="n">border_style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_diff_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;LAMMPS input diff&quot;</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span>
                <span class="n">old</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
                <span class="n">new</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
                <span class="n">fromfile</span><span class="o">=</span><span class="s2">&quot;in.lammps (before)&quot;</span><span class="p">,</span>
                <span class="n">tofile</span><span class="o">=</span><span class="s2">&quot;in.lammps (after)&quot;</span><span class="p">,</span>
                <span class="n">lineterm</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diff</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="s2">&quot;(no changes)&quot;</span>
        <span class="n">syn</span> <span class="o">=</span> <span class="n">Syntax</span><span class="p">(</span>
            <span class="n">diff</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;monokai&quot;</span><span class="p">,</span> <span class="n">line_numbers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">word_wrap</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="n">Panel</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[bold]</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">,</span> <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_safe_json_loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;`&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_and_trim_data_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read LAMMPS data file and trim to token limit for LLM context.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_max_lines</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_max_lines</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data file trimmed from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_max_lines</span><span class="si">}</span><span class="s2"> lines&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Could not read data file.&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_copy_data_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy data file to workspace and return new path.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found: </span><span class="si">{</span><span class="n">data_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">)</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">data_file_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file copied to workspace: </span><span class="si">{</span><span class="n">dest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dest_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_copy_user_potential_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy user-provided potential files to workspace.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Copying user-provided potential files to workspace...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pot_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_potential_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pot_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential file not found: </span><span class="si">{</span><span class="n">pot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pot_file</span><span class="p">)</span>
            <span class="n">dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">pot_file</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential files copied to workspace: </span><span class="si">{</span><span class="n">dest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error copying </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_user_potential_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a wrapper object for user-provided potential to match atomman interface.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_user_potential_files</span><span class="p">()</span>

        <span class="c1"># Create a simple object that mimics the atomman potential interface</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">UserPotential</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_style</span><span class="p">,</span> <span class="n">pair_coeff</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pair_style</span> <span class="o">=</span> <span class="n">pair_style</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pair_coeff</span> <span class="o">=</span> <span class="n">pair_coeff</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">pair_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;pair_style </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pair_style</span><span class="si">}</span><span class="se">\n</span><span class="s2">pair_coeff </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pair_coeff</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">user_potential</span> <span class="o">=</span> <span class="n">UserPotential</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_pair_style</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_pair_coeff</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;chosen_potential&quot;</span><span class="p">:</span> <span class="n">user_potential</span><span class="p">,</span>
            <span class="s2">&quot;fix_attempts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;run_history&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_and_trim_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">downloaded</span> <span class="o">=</span> <span class="n">trafilatura</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">downloaded</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No metadata available&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">trafilatura</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">downloaded</span><span class="p">,</span>
            <span class="n">include_comments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">include_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">include_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">favor_recall</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No metadata available&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">encoding_for_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiktoken_model</span><span class="p">)</span>
            <span class="n">toks</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">:</span>
                <span class="n">toks</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_entry_router</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># Check if using user-provided potential</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_user_potential</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_potential_only</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot set find_potential_only=True when providing your own potential!&quot;</span>
                <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using user-provided potential files&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_potential_only</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chosen_potential&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;You cannot set find_potential_only=True and also specify your own potential!&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_copy_data_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not process data file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chosen_potential&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">potential_summaries_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span> <span class="s2">&quot;potential_summaries&quot;</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potential_summaries_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_potentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">am</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span><span class="n">remote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_lammps_potentials</span><span class="p">(</span>
            <span class="n">pair_style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pair_styles</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;matches&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span>
            <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;summaries&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;full_texts&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;fix_attempts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;run_history&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;matches&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No potentials found in NIST for this task. Exiting....&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;done_no_matches&quot;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_potentials</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s2">&quot;summarize_one&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;summarize_done&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summarizing potential #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;matches&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">metadata</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">md</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;No metadata available&quot;</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;No summary available&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s2">&quot;comments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_and_trim_text</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">url</span>
                <span class="k">else</span> <span class="s2">&quot;No metadata available&quot;</span>
            <span class="p">)</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summ_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                <span class="s2">&quot;simulation_task&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;simulation_task&quot;</span><span class="p">],</span>
            <span class="p">})</span>

        <span class="n">summary_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">potential_summaries_dir</span><span class="p">,</span> <span class="s2">&quot;potential_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">summary_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;summaries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">*</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;summaries&quot;</span><span class="p">],</span> <span class="n">summary</span><span class="p">],</span>
            <span class="s2">&quot;full_texts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">*</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;full_texts&quot;</span><span class="p">],</span> <span class="n">text</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;summaries&quot;</span><span class="p">]):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;matches&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary of potential #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;summaries_combined&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_choose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span><span class="s2">&quot;Choosing potential&quot;</span><span class="p">)</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
            <span class="s2">&quot;summaries_combined&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;summaries_combined&quot;</span><span class="p">],</span>
            <span class="s2">&quot;simulation_task&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;simulation_task&quot;</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="n">choice_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_json_loads</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
        <span class="n">chosen_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_dict</span><span class="p">[</span><span class="s2">&quot;Chosen index&quot;</span><span class="p">])</span>

        <span class="n">chosen_potential</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;matches&quot;</span><span class="p">][</span><span class="n">chosen_index</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_panel</span><span class="p">(</span>
            <span class="s2">&quot;Chosen Potential&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Index:[/bold] </span><span class="si">{</span><span class="n">chosen_index</span><span class="si">}</span><span class="se">\n</span><span class="s2">[bold]ID:[/bold] </span><span class="si">{</span><span class="n">chosen_potential</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">[bold]Rationale:[/bold]</span><span class="se">\n</span><span class="si">{</span><span class="n">choice_dict</span><span class="p">[</span><span class="s1">&#39;rationale&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potential_summaries_dir</span><span class="p">,</span> <span class="s2">&quot;Rationale.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chosen potential #</span><span class="si">{</span><span class="n">chosen_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Rationale for choosing this potential:&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">choice_dict</span><span class="p">[</span><span class="s2">&quot;rationale&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;chosen_potential&quot;</span><span class="p">:</span> <span class="n">chosen_potential</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_route_after_summarization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_potential_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Exit&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;continue_author&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_author</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span><span class="s2">&quot;First attempt at writing LAMMPS input file&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_user_potential</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;chosen_potential&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">download_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span>
        <span class="n">pair_info</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;chosen_potential&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pair_info</span><span class="p">()</span>

        <span class="n">data_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">:</span>
            <span class="n">data_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_and_trim_data_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">)</span>

        <span class="n">authored_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
            <span class="s2">&quot;simulation_task&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;simulation_task&quot;</span><span class="p">],</span>
            <span class="s2">&quot;pair_info&quot;</span><span class="p">:</span> <span class="n">pair_info</span><span class="p">,</span>
            <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">],</span>
            <span class="s2">&quot;data_file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">,</span>
            <span class="s2">&quot;data_content&quot;</span><span class="p">:</span> <span class="n">data_content</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">script_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_json_loads</span><span class="p">(</span><span class="n">authored_json</span><span class="p">)</span>
        <span class="n">input_script</span> <span class="o">=</span> <span class="n">script_dict</span><span class="p">[</span><span class="s2">&quot;input_script&quot;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span> <span class="s2">&quot;in.lammps&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">input_script</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span><span class="s2">&quot;Authored LAMMPS input&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code_panel</span><span class="p">(</span>
            <span class="s2">&quot;in.lammps&quot;</span><span class="p">,</span> <span class="n">input_script</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;input_script&quot;</span><span class="p">:</span> <span class="n">input_script</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span><span class="s2">&quot;Running LAMMPS&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngpus</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="p">,</span>
                    <span class="s2">&quot;-np&quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lammps_cmd</span><span class="p">,</span>
                    <span class="s2">&quot;-in&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;in.lammps&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-k&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;on&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;g&quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngpus</span><span class="p">),</span>
                    <span class="s2">&quot;-sf&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;kk&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-pk&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;kokkos&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;neigh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;half&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;newton&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;on&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="p">,</span>
                    <span class="s2">&quot;-np&quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lammps_cmd</span><span class="p">,</span>
                    <span class="s2">&quot;-in&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;in.lammps&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">status_style</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_panel</span><span class="p">(</span>
            <span class="s2">&quot;Run Result&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;returncode = </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">status_style</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">err_view</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;(no output captured)&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_panel</span><span class="p">(</span><span class="s2">&quot;Run error/output&quot;</span><span class="p">,</span> <span class="n">err_view</span><span class="p">[</span><span class="o">-</span><span class="mi">6000</span><span class="p">:],</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="n">hist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_history&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;attempt&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fix_attempts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;input_script&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_script&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
            <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
            <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;run_returncode&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
            <span class="s2">&quot;run_stdout&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
            <span class="s2">&quot;run_stderr&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="s2">&quot;run_history&quot;</span><span class="p">:</span> <span class="n">hist</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_route_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_returncode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fix_attempts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span><span class="s2">&quot;LAMMPS run successful! Exiting...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;done_success&quot;</span>
        <span class="k">if</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_fix_attempts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span>
                <span class="s2">&quot;LAMMPS run Failed. Attempting to rewrite input file...&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;need_fix&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span>
            <span class="s2">&quot;LAMMPS run Failed and maximum fix attempts reached. Exiting..&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;done_failed&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="n">pair_info</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;chosen_potential&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pair_info</span><span class="p">()</span>

        <span class="n">hist</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_history&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hist</span><span class="p">:</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;attempt&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fix_attempts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s2">&quot;input_script&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_script&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_returncode&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">]</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;=== Attempt </span><span class="si">{attempt}</span><span class="s2"> | returncode=</span><span class="si">{returncode}</span><span class="s2"> ===</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;--- input_script ---</span><span class="se">\n</span><span class="si">{input_script}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;--- stdout ---</span><span class="se">\n</span><span class="si">{stdout}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;--- stderr ---</span><span class="se">\n</span><span class="si">{stderr}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">h</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">err_blob</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

        <span class="n">data_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">:</span>
            <span class="n">data_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_and_trim_data_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">)</span>

        <span class="n">fixed_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
            <span class="s2">&quot;simulation_task&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;simulation_task&quot;</span><span class="p">],</span>
            <span class="s2">&quot;err_message&quot;</span><span class="p">:</span> <span class="n">err_blob</span><span class="p">,</span>
            <span class="s2">&quot;pair_info&quot;</span><span class="p">:</span> <span class="n">pair_info</span><span class="p">,</span>
            <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">],</span>
            <span class="s2">&quot;data_file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file</span><span class="p">,</span>
            <span class="s2">&quot;data_content&quot;</span><span class="p">:</span> <span class="n">data_content</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">script_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_json_loads</span><span class="p">(</span><span class="n">fixed_json</span><span class="p">)</span>

        <span class="n">new_input</span> <span class="o">=</span> <span class="n">script_dict</span><span class="p">[</span><span class="s2">&quot;input_script&quot;</span><span class="p">]</span>
        <span class="n">old_input</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;input_script&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diff_panel</span><span class="p">(</span><span class="n">old_input</span><span class="p">,</span> <span class="n">new_input</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span> <span class="s2">&quot;in.lammps&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_input</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;input_script&quot;</span><span class="p">:</span> <span class="n">new_input</span><span class="p">,</span>
            <span class="s2">&quot;fix_attempts&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fix_attempts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section</span><span class="p">(</span>
            <span class="s2">&quot;Now handing things off to execution agent for summarization/visualization&quot;</span>
        <span class="p">)</span>

        <span class="n">executor</span> <span class="o">=</span> <span class="n">ExecutionAgent</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">)</span>

        <span class="n">exe_plan</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        You are part of a larger scientific workflow whose purpose is to accomplish this task: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;simulation_task&quot;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        A LAMMPS simulation has been done and the output is located in the file &#39;log.lammps&#39;.</span>
<span class="s2">        Summarize the contents of this file in a markdown document. Include a plot, if relevent.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">exe_results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">exe_plan</span><span class="p">)],</span>
            <span class="s2">&quot;workspace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exe_results</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LammpsState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LammpsState</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entry_router</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_potentials</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summarize_one</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_summaries</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_choose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_user_potential_wrapper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_author</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_lammps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_post_run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summarize</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;_entry_router&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;_entry_router&quot;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;user_potential&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_user_potential</span>
            <span class="k">else</span> <span class="p">(</span>
                <span class="s2">&quot;user_choice&quot;</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chosen_potential&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="s2">&quot;agent_choice&quot;</span>
            <span class="p">),</span>
            <span class="p">{</span>
                <span class="s2">&quot;user_potential&quot;</span><span class="p">:</span> <span class="s2">&quot;_create_user_potential_wrapper&quot;</span><span class="p">,</span>
                <span class="s2">&quot;user_choice&quot;</span><span class="p">:</span> <span class="s2">&quot;_author&quot;</span><span class="p">,</span>
                <span class="s2">&quot;agent_choice&quot;</span><span class="p">:</span> <span class="s2">&quot;_find_potentials&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;_find_potentials&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_should_summarize</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;summarize_one&quot;</span><span class="p">:</span> <span class="s2">&quot;_summarize_one&quot;</span><span class="p">,</span>
                <span class="s2">&quot;summarize_done&quot;</span><span class="p">:</span> <span class="s2">&quot;_build_summaries&quot;</span><span class="p">,</span>
                <span class="s2">&quot;done_no_matches&quot;</span><span class="p">:</span> <span class="n">END</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;_summarize_one&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_should_summarize</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;summarize_one&quot;</span><span class="p">:</span> <span class="s2">&quot;_summarize_one&quot;</span><span class="p">,</span>
                <span class="s2">&quot;summarize_done&quot;</span><span class="p">:</span> <span class="s2">&quot;_build_summaries&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_build_summaries&quot;</span><span class="p">,</span> <span class="s2">&quot;_choose&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;_choose&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_route_after_summarization</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;continue_author&quot;</span><span class="p">:</span> <span class="s2">&quot;_author&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Exit&quot;</span><span class="p">:</span> <span class="n">END</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_create_user_potential_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;_author&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_author&quot;</span><span class="p">,</span> <span class="s2">&quot;_run_lammps&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;_run_lammps&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_route_run</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;need_fix&quot;</span><span class="p">:</span> <span class="s2">&quot;_fix&quot;</span><span class="p">,</span>
                <span class="s2">&quot;done_success&quot;</span><span class="p">:</span> <span class="s2">&quot;_post_run&quot;</span><span class="p">,</span>
                <span class="s2">&quot;done_failed&quot;</span><span class="p">:</span> <span class="n">END</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_fix&quot;</span><span class="p">,</span> <span class="s2">&quot;_run_lammps&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;_post_run&quot;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="s2">&quot;summarize&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize_results</span> <span class="k">else</span> <span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;summarize&quot;</span><span class="p">:</span> <span class="s2">&quot;_summarize&quot;</span><span class="p">,</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="n">END</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_summarize&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.mp_agent" class="doc doc-heading">
            <code>mp_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.mp_agent.MaterialsProjectAgent" class="doc doc-heading">
            <code>MaterialsProjectAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a></code></p>









              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/mp_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MaterialsProjectAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="n">summarize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mp_database&quot;</span><span class="p">,</span>
        <span class="n">summaries_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mp_summaries&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span> <span class="o">=</span> <span class="n">summarize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_results</span> <span class="o">=</span> <span class="n">max_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">database_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">summaries_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span>
        <span class="n">els</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span>  <span class="c1"># e.g. [&quot;Ga&quot;,&quot;In&quot;]</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;band_gap_min&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;band_gap_max&quot;</span><span class="p">])</span>
        <span class="n">e_above_hull</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># only on-hull (stable)</span>
        <span class="n">mats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">MPRester</span><span class="p">()</span> <span class="k">as</span> <span class="n">mpr</span><span class="p">:</span>
            <span class="c1"># get ALL matching materials</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="n">mpr</span><span class="o">.</span><span class="n">materials</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="n">elements</span><span class="o">=</span><span class="n">els</span><span class="p">,</span>
                <span class="n">band_gap</span><span class="o">=</span><span class="n">bg</span><span class="p">,</span>
                <span class="n">energy_above_hull</span><span class="o">=</span><span class="n">e_above_hull</span><span class="p">,</span>
                <span class="n">is_stable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># equivalent filter</span>
            <span class="p">)</span>
            <span class="c1"># then take only the first `max_results`</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">all_results</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_results</span><span class="p">]:</span>
                <span class="n">mid</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">material_id</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
                <span class="c1"># cache to disk</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mid</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">mats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;material_id&quot;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;materials&quot;</span><span class="p">:</span> <span class="n">mats</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summarize each material via LLM over its metadata.&quot;&quot;&quot;</span>
        <span class="c1"># prompt template</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are a materials-science assistant. Given the following metadata about a material, produce a concise summary focusing on its key properties:</span>

<span class="si">{metadata}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>

        <span class="n">summaries</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;materials&quot;</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;material_id&quot;</span><span class="p">]</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
            <span class="c1"># flatten metadata to text</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="c1"># build or load summary</span>
            <span class="n">summary_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summaries_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mid</span><span class="si">}</span><span class="s2">_summary.txt&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">summary_file</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">summary_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># optional: vectorize &amp; retrieve, but here we just summarize full text</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">})</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">summary_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;materials&quot;</span><span class="p">]))</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">exe</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">exe</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;materials&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Summarizing materials&quot;</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">summ</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">summaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">summ</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;summaries&quot;</span><span class="p">:</span> <span class="n">summaries</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine all summaries into a single, coherent answer.&quot;&quot;&quot;</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">----</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;material_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;materials&quot;</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;summaries&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        You are a materials informatics assistant. Below are brief summaries of several materials:</span>

<span class="s2">        </span><span class="si">{summaries}</span>

<span class="s2">        Answer the users question in context:</span>

<span class="s2">        </span><span class="si">{context}</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
            <span class="s2">&quot;summaries&quot;</span><span class="p">:</span> <span class="n">combined</span><span class="p">,</span>
            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;final_summary&quot;</span><span class="p">:</span> <span class="n">final</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summarize_node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_node</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;_fetch_node&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_fetch_node&quot;</span><span class="p">,</span> <span class="s2">&quot;_summarize_node&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_summarize_node&quot;</span><span class="p">,</span> <span class="s2">&quot;_aggregate_node&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;_aggregate_node&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;_fetch_node&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;_fetch_node&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.optimization_agent" class="doc doc-heading">
            <code>optimization_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ursa.agents.optimization_agent.run_cmd" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_cmd</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run a commandline command from using the subprocess package in python</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>commandline command to be run as a string given to the subprocess.run command.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/optimization_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_cmd</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">InjectedState</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a commandline command from using the subprocess package in python</span>

<span class="sd">    Args:</span>
<span class="sd">        query: commandline command to be run as a string given to the subprocess.run command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workspace_dir</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RUNNING: &quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">workspace_dir</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60000</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keyboard Interrupt of command: &quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;KeyboardInterrupt:&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STDOUT: &quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STDERR: &quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;STDOUT: </span><span class="si">{</span><span class="n">stdout</span><span class="si">}</span><span class="s2"> and STDERR: </span><span class="si">{</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ursa.agents.optimization_agent.write_code" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Writes python or Julia code to a file in the given workspace as requested.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>code</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The code to write</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the filename with an appropriate extension for programming language (.py for python, .jl for Julia, etc.)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Execution results</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/optimization_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">write_code</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">InjectedState</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes python or Julia code to a file in the given workspace as requested.</span>

<span class="sd">    Args:</span>
<span class="sd">        code: The code to write</span>
<span class="sd">        filename: the filename with an appropriate extension for programming language (.py for python, .jl for Julia, etc.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Execution results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workspace_dir</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing filename &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract code if wrapped in markdown code blocks</span>
        <span class="k">if</span> <span class="s2">&quot;```&quot;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">code_parts</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Extract the actual code</span>
                <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">code_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">code_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Write code to a file</span>
        <span class="n">code_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">code_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Written code to file: </span><span class="si">{</span><span class="n">code_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> written successfully.&quot;</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating code: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Return minimal code that prints the error</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Failed to write </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> successfully.&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.planning_agent" class="doc doc-heading">
            <code>planning_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.planning_agent.PlanningAgent" class="doc doc-heading">
            <code>PlanningAgent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a>[<a class="autorefs autorefs-internal" title="PlanningState (ursa.agents.planning_agent.PlanningState)" href="#ursa.agents.planning_agent.PlanningState">PlanningState</a>]</code></p>









              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/planning_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PlanningAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">[</span><span class="n">PlanningState</span><span class="p">]):</span>
    <span class="n">agent_state</span> <span class="o">=</span> <span class="n">PlanningState</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span>
        <span class="n">max_reflection_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planner_prompt</span> <span class="o">=</span> <span class="n">planner_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflection_prompt</span> <span class="o">=</span> <span class="n">reflection_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_reflection_steps</span> <span class="o">=</span> <span class="n">max_reflection_steps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">PlanningState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generation_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">PlanningState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlanningState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plan generation with structured output. Produces a JSON string in messages</span>
<span class="sd">        and a parsed list of steps in state[&quot;plan_steps&quot;].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PlanningAgent: generating . . .&quot;</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SystemMessage</span><span class="p">):</span>
            <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planner_prompt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planner_prompt</span><span class="p">)]</span> <span class="o">+</span> <span class="n">messages</span>

        <span class="n">structured_llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Plan</span><span class="p">)</span>
        <span class="n">plan</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Plan</span><span class="p">,</span> <span class="n">structured_llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">plan</span><span class="p">,</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">plan</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">())],</span>
            <span class="s2">&quot;reflection_steps&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;reflection_steps&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_reflection_steps</span>
            <span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reflection_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">PlanningState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlanningState</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PlanningAgent: reflecting . . .&quot;</span><span class="p">)</span>

        <span class="n">cls_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ai&quot;</span><span class="p">:</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span> <span class="n">AIMessage</span><span class="p">}</span>
        <span class="n">translated</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">cls_map</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">type</span><span class="p">](</span><span class="n">content</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">]</span>
        <span class="n">translated</span> <span class="o">=</span> <span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">reflection_prompt</span><span class="p">)]</span> <span class="o">+</span> <span class="n">translated</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">StrOutputParser</span><span class="p">()</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="n">translated</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;planner&quot;</span><span class="p">,</span> <span class="s2">&quot;reflect&quot;</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">],</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">res</span><span class="p">)],</span>
            <span class="s2">&quot;reflection_steps&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;reflection_steps&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generation_node</span><span class="p">,</span> <span class="s2">&quot;generate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reflection_node</span><span class="p">,</span> <span class="s2">&quot;reflect&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;generate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;generate&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_cond</span><span class="p">(</span>
                <span class="n">_should_reflect</span><span class="p">,</span> <span class="s2">&quot;should_reflect&quot;</span><span class="p">,</span> <span class="s2">&quot;planning_agent&quot;</span>
            <span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;reflect&quot;</span><span class="p">:</span> <span class="s2">&quot;reflect&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="n">END</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;reflect&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_cond</span><span class="p">(</span>
                <span class="n">_should_regenerate</span><span class="p">,</span> <span class="s2">&quot;should_regenerate&quot;</span><span class="p">,</span> <span class="s2">&quot;planning_agent&quot;</span>
            <span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;generate&quot;</span><span class="p">:</span> <span class="s2">&quot;generate&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="n">END</span><span class="p">},</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="ursa.agents.planning_agent.PlanningAgent.generation_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generation_node</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plan generation with structured output. Produces a JSON string in messages
and a parsed list of steps in state["plan_steps"].</p>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/planning_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generation_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">PlanningState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlanningState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plan generation with structured output. Produces a JSON string in messages</span>
<span class="sd">    and a parsed list of steps in state[&quot;plan_steps&quot;].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PlanningAgent: generating . . .&quot;</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SystemMessage</span><span class="p">):</span>
        <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planner_prompt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planner_prompt</span><span class="p">)]</span> <span class="o">+</span> <span class="n">messages</span>

    <span class="n">structured_llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Plan</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Plan</span><span class="p">,</span> <span class="n">structured_llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">plan</span><span class="p">,</span>
        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">plan</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">())],</span>
        <span class="s2">&quot;reflection_steps&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;reflection_steps&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_reflection_steps</span>
        <span class="p">),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ursa.agents.planning_agent.PlanningState" class="doc doc-heading">
            <code>PlanningState</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.TypedDict">TypedDict</span></code></p>


        <p>State dictionary for planning agent</p>








              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/planning_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PlanningState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;State dictionary for planning agent&quot;&quot;&quot;</span>

    <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_messages</span><span class="p">]</span>
    <span class="n">reflection_steps</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ursa.agents.websearch_agent" class="doc doc-heading">
            <code>websearch_agent</code>


</h2>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="ursa.agents.websearch_agent.WebSearchAgentLegacy" class="doc doc-heading">
            <code>WebSearchAgentLegacy</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAgent (ursa.agents.base.BaseAgent)" href="#ursa.agents.base.BaseAgent">BaseAgent</a></code></p>









              <details class="quote">
                <summary>Source code in <code>src/ursa/agents/websearch_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WebSearchAgentLegacy</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">BaseChatModel</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websearch_prompt</span> <span class="o">=</span> <span class="n">websearch_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflection_prompt</span> <span class="o">=</span> <span class="n">reflection_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">search_tool</span><span class="p">,</span> <span class="n">process_content</span><span class="p">]</span>  <span class="c1"># + cb_tools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_internet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_internet</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;http://www.lanl.gov&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_review_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">WebSearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebSearchState</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_internet</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">HumanMessage</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;No internet for WebSearch Agent so no research to review.&quot;</span>
                    <span class="p">)</span>
                <span class="p">],</span>
                <span class="s2">&quot;urls_visited&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>

        <span class="n">translated</span> <span class="o">=</span> <span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">reflection_prompt</span><span class="p">)]</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span>
            <span class="s2">&quot;messages&quot;</span>
        <span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">StrOutputParser</span><span class="p">()</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="n">translated</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span><span class="p">}}</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">res</span><span class="p">)]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_response_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">WebSearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebSearchState</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_internet</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">HumanMessage</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;No internet for WebSearch Agent. No research carried out.&quot;</span>
                    <span class="p">)</span>
                <span class="p">],</span>
                <span class="s2">&quot;urls_visited&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">summarize_prompt</span><span class="p">)]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">StrOutputParser</span><span class="p">()</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span><span class="p">}}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">urls_visited</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                    <span class="n">urls_visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">response</span><span class="p">],</span> <span class="s2">&quot;urls_visited&quot;</span><span class="p">:</span> <span class="n">urls_visited</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_for_internet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks for internet connectivity by attempting an HTTP GET request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_state_store_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">WebSearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebSearchState</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span>
        <span class="k">return</span> <span class="n">state</span>
        <span class="c1"># return dict(**state, thread_id=self.thread_id)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_react</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">WebSearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebSearchState</span><span class="p">:</span>
        <span class="n">react_agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">state_schema</span><span class="o">=</span><span class="n">WebSearchState</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">websearch_prompt</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">react_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state_store_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_react</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;_state_store_node&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_state_store_node&quot;</span><span class="p">,</span> <span class="s2">&quot;_create_react&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;_create_react&quot;</span><span class="p">,</span> <span class="s2">&quot;_review_node&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;_response_node&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;_review_node&quot;</span><span class="p">,</span>
            <span class="n">should_continue</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;_create_react&quot;</span><span class="p">:</span> <span class="s2">&quot;_create_react&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_response_node&quot;</span><span class="p">:</span> <span class="s2">&quot;_response_node&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="ursa.agents.websearch_agent.process_content" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_content</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Processes content from a given webpage.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>string with the url to obtain text content from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>string summary of the information the agent wants from the url for summarizing salient information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ursa/agents/websearch_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_content</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">InjectedState</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes content from a given webpage.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: string with the url to obtain text content from.</span>
<span class="sd">        context: string summary of the information the agent wants from the url for summarizing salient information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing information from &quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

    <span class="n">content_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Here is the full content:</span>
<span class="s2">    </span><span class="si">{</span><span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="si">}</span>

<span class="s2">    Carefully summarize the content in full detail, given the following context:</span>
<span class="s2">    </span><span class="si">{</span><span class="n">context</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">summarized_information</span> <span class="o">=</span> <span class="n">StrOutputParser</span><span class="p">()</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="n">content_prompt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]}}</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">summarized_information</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>